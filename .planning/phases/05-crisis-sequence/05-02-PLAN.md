---
phase: 05-crisis-sequence
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - src/stores/CharacterStore.ts
autonomous: true

must_haves:
  truths:
    - "On day 10, Mother moves visibly slower as warning sign"
    - "Elling enters shadow state when overskudd < 30 during crisis"
    - "Shadow state visually indicated (for later UI consumption)"
  artifacts:
    - path: "src/stores/CharacterStore.ts"
      provides: "Warning sign movement and shadow state computed properties"
      contains: "inShadowState"
  key_links:
    - from: "src/stores/CharacterStore.ts"
      to: "src/stores/CrisisStore.ts"
      via: "crisisState observation"
      pattern: "crisisStore\\.crisisState"
---

<objective>
Add shadow state behavior for Elling and warning signs for Mother on Day 10.

Purpose: Implement CHAR-04 (shadow state) and the pre-crisis warning signs that give players subtle hints before the collapse. These character enhancements integrate with the CrisisStore from Plan 01.

Output: Character class extended with shadow state and warning sign behavior.
</objective>

<execution_context>
@/Users/godstemning/.claude/get-shit-done/workflows/execute-plan.md
@/Users/godstemning/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-crisis-sequence/05-CONTEXT.md
@.planning/phases/05-crisis-sequence/05-RESEARCH.md
@.planning/phases/05-crisis-sequence/05-01-SUMMARY.md

@src/stores/CharacterStore.ts
@src/stores/CrisisStore.ts (from Plan 01)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Shadow State to Character</name>
  <files>src/stores/CharacterStore.ts</files>
  <action>
Add shadow state computed properties to the Character class. These implement CHAR-04: Blue personality paralysis under stress.

In the Character class, after the `comfortActivity` getter (around line 110), add:

```typescript
/**
 * Is character in shadow state?
 * Blue shadow = paralysis under extreme stress
 * Triggers when: Blue primary color + crisis active + overskudd < 30
 */
get inShadowState(): boolean {
  // Only Blue primary characters have shadow state
  if (this.colors.primary.color !== 'blue') return false;

  // Only during active crisis
  const crisisState = this.characterStore.rootStore.crisisStore?.crisisState;
  if (crisisState !== 'active') return false;

  // Shadow threshold: overskudd below 30
  return this.overskudd < 30;
}

/**
 * Shadow state penalty applied to crisis action success
 * -20% when in shadow state
 */
get shadowPenalty(): number {
  return this.inShadowState ? 20 : 0;
}
```

The `?.` optional chaining handles the case where crisisStore might not exist during store initialization.
  </action>
  <verify>
- `npm run build` passes
- `grep "inShadowState" src/stores/CharacterStore.ts` shows the getter
  </verify>
  <done>
- Blue characters have `inShadowState` computed property
- Shadow triggers when: Blue primary + active crisis + overskudd < 30
- `shadowPenalty` returns 20 when in shadow, 0 otherwise
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Warning Sign Movement for Mother</name>
  <files>src/stores/CharacterStore.ts</files>
  <action>
Modify the walking speed calculation to show Mother slowing down on Day 10 as a warning sign.

Replace the `baseWalkSpeed` getter with a new `currentWalkSpeed` getter that includes warning sign logic:

```typescript
/**
 * Base walking speed (pixels per game-minute)
 * Blue personality = slower (30 px/min), others = faster (50 px/min)
 */
get baseWalkSpeed(): number {
  return this.colors.primary.color === 'blue' ? 30 : 50;
}

/**
 * Current walking speed with modifiers
 * On Day 10, Mother progressively slows as warning sign
 */
get currentWalkSpeed(): number {
  let speed = this.baseWalkSpeed;

  // Warning sign: Mother slows down on Day 10
  if (this.id === 'mother') {
    const timeStore = this.characterStore.rootStore.timeStore;
    if (timeStore.day === 10) {
      const hour = timeStore.hour;
      // Progressive slowdown: 80% at 8am, 60% at 11am, 30% at 13pm
      if (hour >= 13) {
        speed *= 0.3;
      } else if (hour >= 11) {
        speed *= 0.6;
      } else if (hour >= 8) {
        speed *= 0.8;
      }
    }
  }

  return speed;
}
```

Then update `updateWalking` method to use `currentWalkSpeed` instead of `baseWalkSpeed`:

Find the line (around line 232):
```typescript
const speed = (this.overskudd / 100) * this.baseWalkSpeed * gameMinutes;
```

Replace with:
```typescript
const speed = (this.overskudd / 100) * this.currentWalkSpeed * gameMinutes;
```
  </action>
  <verify>
- `npm run build` passes
- `grep "currentWalkSpeed" src/stores/CharacterStore.ts` shows the getter
- Mother's movement speed calculation includes day 10 check
  </verify>
  <done>
- Mother has `currentWalkSpeed` that reduces on Day 10
- Warning progression: 80% at hour 8, 60% at hour 11, 30% at hour 13
- Walking uses currentWalkSpeed (includes both overskudd scaling and warning modifier)
  </done>
</task>

<task type="auto">
  <name>Task 3: Add Elling Concern Thought (Optional Enhancement)</name>
  <files>src/stores/CharacterStore.ts</files>
  <action>
Add a computed property to indicate when Elling should show concern about Mother. This will be used by the UI to occasionally show worried thoughts.

In the Character class, add after the shadow state getters:

```typescript
/**
 * Should Elling show concern about Mother?
 * On Day 10 warning phase, occasionally true for thought bubble
 */
get isWorriedAboutMother(): boolean {
  if (this.id !== 'elling') return false;

  const crisisState = this.characterStore.rootStore.crisisStore?.crisisState;
  if (crisisState !== 'warning') return false;

  // During warning phase, check if Mother is moving slowly
  const mother = this.characterStore.getCharacter('mother');
  if (!mother) return false;

  // Worried when Mother's speed modifier is below 70%
  const timeStore = this.characterStore.rootStore.timeStore;
  if (timeStore.day === 10) {
    const hour = timeStore.hour;
    // Elling notices something is wrong when Mother is visibly slower
    return hour >= 11;
  }

  return false;
}
```

This property can be used by ThoughtBubble or other UI components to show concern thoughts like "Mother seems tired..." during the warning phase.
  </action>
  <verify>
- `npm run build` passes
- `grep "isWorriedAboutMother" src/stores/CharacterStore.ts` shows the getter
  </verify>
  <done>
- Elling has `isWorriedAboutMother` computed property
- Returns true during warning phase when hour >= 11 (when Mother is visibly slower)
- UI can use this to show concerned thought bubbles
  </done>
</task>

</tasks>

<verification>
1. `npm run build` completes without errors
2. `npm run dev` starts and game runs normally
3. Shadow state getters exist: `grep -E "(inShadowState|shadowPenalty)" src/stores/CharacterStore.ts`
4. Warning speed exists: `grep "currentWalkSpeed" src/stores/CharacterStore.ts`
5. Concern property exists: `grep "isWorriedAboutMother" src/stores/CharacterStore.ts`
</verification>

<success_criteria>
- Elling has inShadowState and shadowPenalty computed properties
- Shadow state triggers for Blue characters during active crisis with low overskudd
- Mother's currentWalkSpeed reduces progressively on Day 10
- Elling can detect when to show concern about Mother
- Build passes, game runs without errors
</success_criteria>

<output>
After completion, create `.planning/phases/05-crisis-sequence/05-02-SUMMARY.md`
</output>
