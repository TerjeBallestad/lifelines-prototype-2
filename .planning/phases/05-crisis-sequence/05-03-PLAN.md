---
phase: 05-crisis-sequence
plan: 03
type: execute
wave: 3
depends_on: ["05-01", "05-02"]
files_modified:
  - src/components/CrisisModal.tsx
  - src/components/CrisisActionButton.tsx
  - src/components/Game.tsx
autonomous: true

must_haves:
  truths:
    - "Crisis modal appears as full-screen overlay when crisis is active"
    - "Player can see available actions with skill level and success chance"
    - "Attempting action shows skill check result (success/failure)"
    - "Failed actions can be retried with visible penalty"
  artifacts:
    - path: "src/components/CrisisModal.tsx"
      provides: "Main crisis UI overlay with action selection"
      min_lines: 80
    - path: "src/components/CrisisActionButton.tsx"
      provides: "Individual action button with skill display"
      min_lines: 30
  key_links:
    - from: "src/components/CrisisModal.tsx"
      to: "src/stores/CrisisStore.ts"
      via: "observer + useGameStore"
      pattern: "crisisStore\\.crisisState"
    - from: "src/components/Game.tsx"
      to: "src/components/CrisisModal.tsx"
      via: "component render"
      pattern: "<CrisisModal"
---

<objective>
Create the crisis modal UI that appears when Mother collapses on Day 10.

Purpose: Provide the player interface for the crisis sequence - showing the urgent situation, available actions, skill checks, and action results. This is the primary gameplay interface for the crisis.

Output: CrisisModal and CrisisActionButton components, integrated into Game.tsx.
</objective>

<execution_context>
@/Users/godstemning/.claude/get-shit-done/workflows/execute-plan.md
@/Users/godstemning/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-crisis-sequence/05-CONTEXT.md
@.planning/phases/05-crisis-sequence/05-RESEARCH.md
@.planning/phases/05-crisis-sequence/05-01-SUMMARY.md
@.planning/phases/05-crisis-sequence/05-02-SUMMARY.md

@src/components/QuestCelebration.tsx (pattern reference)
@src/components/ActivityModal.tsx (skill display reference)
@src/components/Game.tsx
@src/stores/CrisisStore.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CrisisActionButton Component</name>
  <files>src/components/CrisisActionButton.tsx</files>
  <action>
Create `src/components/CrisisActionButton.tsx` - individual action button with skill check display:

```typescript
import { observer } from 'mobx-react-lite';
import { motion } from 'motion/react';
import type { CrisisAction } from '../types/game';
import { useGameStore } from '../stores/RootStore';

interface CrisisActionButtonProps {
  action: CrisisAction;
  onSelect: (action: CrisisAction) => void;
  disabled?: boolean;
}

/**
 * Button for a crisis action showing skill level and success chance
 * Displays retry count if action has been attempted before
 */
export const CrisisActionButton = observer(function CrisisActionButton({
  action,
  onSelect,
  disabled = false,
}: CrisisActionButtonProps) {
  const { crisisStore, skillStore } = useGameStore();

  const skill = skillStore.getSkill('elling', action.skillCategory);
  const skillLevel = skill?.level ?? 1;
  const successChance = crisisStore.getActionSuccessChance(action.id);
  const attempts = crisisStore.actionAttempts.get(action.id) ?? 0;

  // Color-code success chance
  const chanceColor =
    successChance >= 60
      ? 'text-success'
      : successChance >= 40
        ? 'text-warning'
        : 'text-error';

  return (
    <motion.button
      whileHover={{ scale: disabled ? 1 : 1.02 }}
      whileTap={{ scale: disabled ? 1 : 0.98 }}
      className={`btn btn-lg w-full justify-start gap-4 ${
        disabled ? 'btn-disabled opacity-50' : 'btn-outline btn-error'
      }`}
      onClick={() => !disabled && onSelect(action)}
      disabled={disabled}
    >
      {/* Icon */}
      <span className="text-3xl">{action.icon}</span>

      {/* Action info */}
      <div className="flex-1 text-left">
        <div className="font-bold">{action.name}</div>
        <div className="text-sm opacity-70">{action.description}</div>
        <div className="mt-1 flex items-center gap-2 text-xs">
          <span className="badge badge-sm badge-ghost">
            {action.skillCategory} Lv.{skillLevel}
          </span>
          {attempts > 0 && (
            <span className="badge badge-sm badge-warning">
              Retry #{attempts}
            </span>
          )}
          {action.givesHopeBonus && (
            <span className="badge badge-sm badge-info">+Hope</span>
          )}
        </div>
      </div>

      {/* Success chance */}
      <div className="text-right">
        <div className={`text-2xl font-bold ${chanceColor}`}>
          {successChance}%
        </div>
        <div className="text-xs opacity-60">success</div>
      </div>
    </motion.button>
  );
});
```
  </action>
  <verify>File exists and exports CrisisActionButton component</verify>
  <done>CrisisActionButton displays action icon, name, skill level, retry count, and success chance</done>
</task>

<task type="auto">
  <name>Task 2: Create CrisisModal Component</name>
  <files>src/components/CrisisModal.tsx</files>
  <action>
Create `src/components/CrisisModal.tsx` - main crisis UI overlay:

```typescript
import { useEffect, useState } from 'react';
import { observer } from 'mobx-react-lite';
import { motion, AnimatePresence } from 'motion/react';
import { AlertTriangle, Heart } from 'lucide-react';
import { useGameStore } from '../stores/RootStore';
import { CrisisActionButton } from './CrisisActionButton';
import type { CrisisAction, CrisisActionResult } from '../types/game';

/**
 * Full-screen crisis modal that appears when Mother collapses
 * Shows urgent situation, available actions, and skill check results
 */
export const CrisisModal = observer(function CrisisModal() {
  const { crisisStore, characterStore } = useGameStore();
  const [showingResult, setShowingResult] = useState(false);
  const [currentResult, setCurrentResult] = useState<CrisisActionResult | null>(null);

  const elling = characterStore.getCharacter('elling');
  const inShadow = elling?.inShadowState ?? false;

  // Only show during active crisis
  if (crisisStore.crisisState !== 'active') return null;

  const handleActionSelect = (action: CrisisAction) => {
    const result = crisisStore.attemptAction(action.id);
    if (result) {
      setCurrentResult(result);
      setShowingResult(true);

      // Auto-clear result after showing
      setTimeout(() => {
        setShowingResult(false);
        setCurrentResult(null);
        crisisStore.clearLastActionResult();
      }, 2500);
    }
  };

  const handleGiveUp = () => {
    crisisStore.giveUp();
  };

  return (
    <AnimatePresence>
      <motion.div
        initial={{ opacity: 0 }}
        animate={{ opacity: 1 }}
        exit={{ opacity: 0 }}
        className="fixed inset-0 z-50 flex items-center justify-center bg-black/80"
      >
        {/* Urgent red pulse background effect */}
        <motion.div
          animate={{ opacity: [0.1, 0.2, 0.1] }}
          transition={{ repeat: Infinity, duration: 2 }}
          className="absolute inset-0 bg-error/20"
        />

        {/* Main content */}
        <motion.div
          initial={{ scale: 0.9, y: 20 }}
          animate={{ scale: 1, y: 0 }}
          className="relative z-10 mx-4 max-h-[90vh] w-full max-w-lg overflow-y-auto rounded-2xl bg-base-100 p-6 shadow-2xl"
        >
          {/* Header with alert */}
          <div className="mb-6 text-center">
            <motion.div
              animate={{ scale: [1, 1.1, 1] }}
              transition={{ repeat: Infinity, duration: 1 }}
              className="mb-3 inline-block"
            >
              <AlertTriangle className="h-16 w-16 text-error" />
            </motion.div>
            <h2 className="text-2xl font-bold text-error">CRISIS!</h2>
            <p className="mt-2 text-base-content/80">
              Mother has collapsed on the floor. She's not responding.
            </p>
          </div>

          {/* Shadow state warning */}
          {inShadow && (
            <motion.div
              initial={{ opacity: 0, height: 0 }}
              animate={{ opacity: 1, height: 'auto' }}
              className="mb-4 rounded-lg bg-warning/20 p-3 text-center text-sm"
            >
              <span className="font-medium text-warning">
                Elling is paralyzed with anxiety. Actions are harder.
              </span>
            </motion.div>
          )}

          {/* Hope bonus indicator */}
          {crisisStore.hopeBonus > 0 && (
            <div className="mb-4 flex items-center justify-center gap-2 text-sm text-info">
              <Heart className="h-4 w-4" />
              <span>+{crisisStore.hopeBonus}% hope bonus for phone call</span>
            </div>
          )}

          {/* Action result overlay */}
          <AnimatePresence>
            {showingResult && currentResult && (
              <motion.div
                initial={{ opacity: 0, scale: 0.8 }}
                animate={{ opacity: 1, scale: 1 }}
                exit={{ opacity: 0, scale: 0.8 }}
                className={`mb-4 rounded-xl p-4 text-center ${
                  currentResult.succeeded
                    ? 'bg-success/20 text-success'
                    : 'bg-error/20 text-error'
                }`}
              >
                <div className="text-4xl">
                  {currentResult.succeeded ? '✓' : '✗'}
                </div>
                <div className="mt-1 text-lg font-bold">
                  {currentResult.succeeded ? 'Success!' : 'Failed...'}
                </div>
                <div className="text-sm opacity-80">
                  Rolled {Math.floor(currentResult.roll)} vs {currentResult.chance}%
                </div>
                {!currentResult.succeeded && (
                  <div className="mt-1 text-xs">
                    Try again (chance reduced by 15%)
                  </div>
                )}
              </motion.div>
            )}
          </AnimatePresence>

          {/* Actions list */}
          <div className="space-y-3">
            {crisisStore.actions.map((action) => (
              <CrisisActionButton
                key={action.id}
                action={action}
                onSelect={handleActionSelect}
                disabled={showingResult}
              />
            ))}
          </div>

          {/* Give up option */}
          <div className="mt-6 text-center">
            <button
              className="btn btn-ghost btn-sm text-base-content/50"
              onClick={handleGiveUp}
              disabled={showingResult}
            >
              I can't do this...
            </button>
          </div>

          {/* Instructions */}
          <div className="mt-4 text-center text-xs text-base-content/50">
            Call emergency services to save Mother. Other actions give hope bonus.
          </div>
        </motion.div>
      </motion.div>
    </AnimatePresence>
  );
});
```
  </action>
  <verify>
- File exists and exports CrisisModal component
- `npm run build` passes
  </verify>
  <done>
- CrisisModal shows urgent overlay with Mother collapsed message
- Shadow state warning displayed when Elling is paralyzed
- Action buttons with skill checks and retry tracking
- Success/failure result display with animation
- Give up option available
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate Crisis in Game.tsx</name>
  <files>src/components/Game.tsx</files>
  <action>
Add crisis detection and CrisisModal to Game.tsx.

1. Add import at top:
```typescript
import { CrisisModal } from './CrisisModal';
```

2. Add crisis detection useEffect after the existing quest completion effect (around line 50-60):
```typescript
// Crisis detection - warning phase
useEffect(() => {
  if (store.crisisStore.shouldStartWarning) {
    store.crisisStore.startWarning();
  }
}, [store.crisisStore.shouldStartWarning, store]);

// Crisis detection - active phase (Mother collapses)
useEffect(() => {
  if (store.crisisStore.shouldTrigger) {
    store.crisisStore.triggerCrisis();
  }
}, [store.crisisStore.shouldTrigger, store]);
```

3. Add CrisisModal to the render, after QuestCelebration and before the closing fragment:
```typescript
{/* Crisis modal */}
<CrisisModal />
```

The CrisisModal handles its own visibility based on crisisStore.crisisState.
  </action>
  <verify>
- `npm run build` passes
- `npm run dev` shows game without errors
- `grep "CrisisModal" src/components/Game.tsx` shows import and usage
  </verify>
  <done>
- Game.tsx imports and renders CrisisModal
- Crisis warning detection triggers at day 10, hour 8
- Crisis active detection triggers at day 10, hour 14
- CrisisModal appears when crisis becomes active
  </done>
</task>

</tasks>

<verification>
1. `npm run build` completes without errors
2. `npm run dev` starts and game runs normally
3. Components exist:
   - `ls src/components/CrisisModal.tsx src/components/CrisisActionButton.tsx`
4. Game integrates crisis:
   - `grep -E "(CrisisModal|shouldStartWarning|shouldTrigger)" src/components/Game.tsx`
</verification>

<success_criteria>
- CrisisActionButton shows action with skill level and success chance
- CrisisModal displays full-screen urgent overlay during active crisis
- Shadow state warning appears when Elling is paralyzed
- Action results show with success/failure animation
- Retry tracking visible with penalty indicator
- Hope bonus displayed when accumulated
- Game.tsx detects warning and active crisis phases
- Build passes, game runs without errors
</success_criteria>

<output>
After completion, create `.planning/phases/05-crisis-sequence/05-03-SUMMARY.md`
</output>
