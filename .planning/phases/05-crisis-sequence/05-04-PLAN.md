---
phase: 05-crisis-sequence
plan: 04
type: execute
wave: 4
depends_on: ["05-03"]
files_modified:
  - src/components/CrisisEpilogue.tsx
  - src/components/Game.tsx
  - src/stores/RootStore.ts
autonomous: false

must_haves:
  truths:
    - "After crisis resolves, epilogue screen shows outcome text"
    - "Saved ending shows Mother survives with hopeful message"
    - "Lost ending shows Mother dies with somber message"
    - "Player can restart game or return to menu after ending"
  artifacts:
    - path: "src/components/CrisisEpilogue.tsx"
      provides: "Ending screen with epilogue text and restart options"
      min_lines: 60
  key_links:
    - from: "src/components/CrisisEpilogue.tsx"
      to: "src/stores/CrisisStore.ts"
      via: "outcome observation"
      pattern: "crisisStore\\.outcome"
    - from: "src/components/Game.tsx"
      to: "src/components/CrisisEpilogue.tsx"
      via: "component render"
      pattern: "<CrisisEpilogue"
---

<objective>
Create the epilogue screen and game reset functionality for the crisis conclusion.

Purpose: Provide narrative closure with outcome-appropriate text, and allow players to restart for another attempt or return to menu. This completes the gameplay loop.

Output: CrisisEpilogue component with two endings, game reset capability, integrated into Game.tsx.
</objective>

<execution_context>
@/Users/godstemning/.claude/get-shit-done/workflows/execute-plan.md
@/Users/godstemning/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-crisis-sequence/05-CONTEXT.md
@.planning/phases/05-crisis-sequence/05-RESEARCH.md
@.planning/phases/05-crisis-sequence/05-01-SUMMARY.md
@.planning/phases/05-crisis-sequence/05-02-SUMMARY.md
@.planning/phases/05-crisis-sequence/05-03-SUMMARY.md

@src/components/QuestCelebration.tsx (modal pattern reference)
@src/data/crisis.ts (EPILOGUE_TEXT)
@src/stores/CrisisStore.ts
@src/stores/RootStore.ts
@src/components/Game.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CrisisEpilogue Component</name>
  <files>src/components/CrisisEpilogue.tsx</files>
  <action>
Create `src/components/CrisisEpilogue.tsx` - the ending screen with epilogue text and restart options:

```typescript
import { observer } from 'mobx-react-lite';
import { motion, AnimatePresence } from 'motion/react';
import { Heart, Skull, RotateCcw, Home } from 'lucide-react';
import { useGameStore } from '../stores/RootStore';
import { EPILOGUE_TEXT } from '../data/crisis';

/**
 * Epilogue screen shown after crisis resolves
 * Displays outcome-appropriate text and offers restart/menu options
 */
export const CrisisEpilogue = observer(function CrisisEpilogue() {
  const store = useGameStore();
  const { crisisStore } = store;

  // Only show when crisis is resolved with an outcome
  if (crisisStore.crisisState !== 'resolved' || !crisisStore.outcome) {
    return null;
  }

  const outcome = crisisStore.outcome;
  const epilogue = EPILOGUE_TEXT[outcome];
  const isSaved = outcome === 'saved';

  const handleRestart = () => {
    store.resetGame();
  };

  const handleMenu = () => {
    // For now, just reload the page as there's no menu system
    window.location.reload();
  };

  return (
    <AnimatePresence>
      <motion.div
        initial={{ opacity: 0 }}
        animate={{ opacity: 1 }}
        exit={{ opacity: 0 }}
        className="fixed inset-0 z-50 flex items-center justify-center bg-black/90"
      >
        <motion.div
          initial={{ scale: 0.9, y: 20 }}
          animate={{ scale: 1, y: 0 }}
          transition={{ delay: 0.3 }}
          className="mx-4 max-h-[90vh] w-full max-w-xl overflow-y-auto rounded-2xl bg-base-100 p-8 shadow-2xl"
        >
          {/* Outcome icon */}
          <motion.div
            initial={{ scale: 0, rotate: -180 }}
            animate={{ scale: 1, rotate: 0 }}
            transition={{ delay: 0.5, type: 'spring', stiffness: 200 }}
            className="mb-6 text-center"
          >
            {isSaved ? (
              <Heart className={`mx-auto h-20 w-20 text-success`} />
            ) : (
              <Skull className={`mx-auto h-20 w-20 text-error`} />
            )}
          </motion.div>

          {/* Title */}
          <motion.h2
            initial={{ opacity: 0, y: 10 }}
            animate={{ opacity: 1, y: 0 }}
            transition={{ delay: 0.7 }}
            className={`mb-6 text-center text-3xl font-bold ${
              isSaved ? 'text-success' : 'text-error'
            }`}
          >
            {epilogue.title}
          </motion.h2>

          {/* Epilogue paragraphs */}
          <div className="mb-8 space-y-4">
            {epilogue.paragraphs.map((paragraph, index) => (
              <motion.p
                key={index}
                initial={{ opacity: 0, y: 10 }}
                animate={{ opacity: 1, y: 0 }}
                transition={{ delay: 0.9 + index * 0.3 }}
                className="text-base-content/80 leading-relaxed"
              >
                {paragraph}
              </motion.p>
            ))}
          </div>

          {/* Action buttons */}
          <motion.div
            initial={{ opacity: 0 }}
            animate={{ opacity: 1 }}
            transition={{ delay: 0.9 + epilogue.paragraphs.length * 0.3 + 0.5 }}
            className="flex flex-col gap-3 sm:flex-row"
          >
            <button
              className="btn btn-primary flex-1 gap-2"
              onClick={handleRestart}
            >
              <RotateCcw className="h-5 w-5" />
              Try Again
            </button>
            <button
              className="btn btn-outline flex-1 gap-2"
              onClick={handleMenu}
            >
              <Home className="h-5 w-5" />
              Return to Menu
            </button>
          </motion.div>

          {/* Hint for players who lost */}
          {!isSaved && (
            <motion.div
              initial={{ opacity: 0 }}
              animate={{ opacity: 1 }}
              transition={{ delay: 0.9 + epilogue.paragraphs.length * 0.3 + 1 }}
              className="mt-6 text-center text-sm text-base-content/50"
            >
              Tip: Train Elling's Social skill to improve phone call success.
            </motion.div>
          )}
        </motion.div>
      </motion.div>
    </AnimatePresence>
  );
});
```
  </action>
  <verify>File exists and exports CrisisEpilogue component</verify>
  <done>
- CrisisEpilogue shows outcome-appropriate icon (Heart for saved, Skull for lost)
- Epilogue paragraphs display with staggered animation
- Try Again and Return to Menu buttons available
- Tip shown for players who lost
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Game Reset Function</name>
  <files>src/stores/RootStore.ts</files>
  <action>
Add a resetGame method to RootStore that resets all stores to initial state.

Add this method to the RootStore class (before the closing brace):

```typescript
/**
 * Reset entire game to initial state
 * Used for "Try Again" after crisis ending
 */
resetGame(): void {
  // Reset time to day 1
  this.timeStore.reset();

  // Reset crisis state
  this.crisisStore.reset();

  // Reset quest progress
  this.questStore.reset();

  // Reset resources
  this.resourceStore.reset();

  // Reset skills (reinitialize from character colors)
  this.skillStore.reset();
  for (const character of this.characterStore.allCharacters) {
    this.skillStore.initializeCharacterSkills(character.id, character.colors);
  }

  // Reset characters (needs and state)
  this.characterStore.reset();
}
```

Now add reset methods to each store that needs one:

**TimeStore** - add reset method:
```typescript
reset(): void {
  this.day = 1;
  this.hour = 6;
  this.minute = 0;
  this.isPaused = true;
}
```

**QuestStore** - add reset method:
```typescript
reset(): void {
  this.currentQuestIndex = 0;
  this.pendingCompletion = null;
}
```

**ResourceStore** - add reset method:
```typescript
reset(): void {
  this.resources.clear();
}
```

**SkillStore** - add reset method:
```typescript
reset(): void {
  this.characterSkills.clear();
}
```

**CharacterStore** - add reset method that reinitializes characters:
```typescript
reset(): void {
  // Reinitialize all characters from data
  this.characters.clear();
  for (const data of CHARACTERS) {
    this.characters.set(data.id, new Character(data, this));
  }
}
```

Note: You'll need to import CHARACTERS at the top of CharacterStore if not already imported:
```typescript
import { CHARACTERS } from '../data/characters';
```
  </action>
  <verify>
- `npm run build` passes
- `grep "resetGame" src/stores/RootStore.ts` shows the method
- `grep "reset()" src/stores/*.ts` shows reset methods in all stores
  </verify>
  <done>
- RootStore has resetGame() that coordinates all store resets
- Each store (Time, Quest, Resource, Skill, Character, Crisis) has reset() method
- Game can be fully reset for "Try Again" functionality
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate CrisisEpilogue in Game.tsx</name>
  <files>src/components/Game.tsx</files>
  <action>
Add CrisisEpilogue to Game.tsx after CrisisModal.

1. Add import at top:
```typescript
import { CrisisEpilogue } from './CrisisEpilogue';
```

2. Add CrisisEpilogue to the render, after CrisisModal:
```typescript
{/* Crisis epilogue (ending screen) */}
<CrisisEpilogue />
```

The CrisisEpilogue handles its own visibility based on crisisStore.crisisState === 'resolved'.
  </action>
  <verify>
- `npm run build` passes
- `grep "CrisisEpilogue" src/components/Game.tsx` shows import and usage
  </verify>
  <done>
- Game.tsx imports and renders CrisisEpilogue
- Epilogue automatically shows when crisis resolves
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete crisis sequence: warning signs, modal with actions, skill checks, epilogue with two endings, and game restart</what-built>
  <how-to-verify>
1. Run `npm run dev` and open the game in browser
2. Use debug controls or time manipulation to reach Day 10:
   - Open browser console and run: `window.__store = rootStore` (if not exposed)
   - Or use any existing debug time controls
3. Verify warning phase (Day 10, hour 8-13):
   - Mother should move noticeably slower
   - Crisis has not yet triggered
4. Verify crisis trigger (Day 10, hour 14+):
   - Full-screen crisis modal appears with red urgent styling
   - Three actions visible: Call Emergency, Help Mother, Run to Neighbor
   - Each shows skill level and success percentage
5. Test action flow:
   - Click "Help Mother" - should show success/failure result
   - If succeeded, hope bonus indicator should appear
   - Try again - retry badge should show, chance should decrease
6. Test phone call:
   - Click "Call Emergency Services"
   - If success: crisis resolves, saved epilogue shows
   - If fail: can retry with reduced chance
7. Test give up:
   - Click "I can't do this..."
   - Lost epilogue should show
8. Test endings:
   - Saved: Heart icon, hopeful text, Try Again button
   - Lost: Skull icon, somber text, hint about Social skill
9. Test restart:
   - Click "Try Again" - game should reset to Day 1
   - All progress cleared, start fresh
  </how-to-verify>
  <resume-signal>Type "approved" if all checks pass, or describe issues found</resume-signal>
</task>

</tasks>

<verification>
1. `npm run build` completes without errors
2. `npm run dev` starts and game runs normally
3. Components exist:
   - `ls src/components/CrisisEpilogue.tsx`
4. Reset methods exist:
   - `grep "reset()" src/stores/*.ts`
5. Game integrates epilogue:
   - `grep "CrisisEpilogue" src/components/Game.tsx`
</verification>

<success_criteria>
- CrisisEpilogue shows after crisis resolves
- Saved ending: Heart icon, hopeful epilogue text
- Lost ending: Skull icon, somber epilogue text with tip
- Try Again button resets game to Day 1
- Return to Menu button reloads page
- All stores have reset() methods
- Game can be played multiple times via restart
</success_criteria>

<output>
After completion, create `.planning/phases/05-crisis-sequence/05-04-SUMMARY.md`
</output>
