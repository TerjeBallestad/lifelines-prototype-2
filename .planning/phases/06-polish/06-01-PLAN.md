---
phase: 06-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/QuestIntroduction.tsx
  - src/components/Game.tsx
  - src/components/LevelUpCelebration.tsx
autonomous: true

must_haves:
  truths:
    - "On game start, first quest shows introduction popup"
    - "After game reset, first quest shows introduction popup"
    - "Debug controls are hidden/collapsed by default"
    - "Celebration messages work for any character, not just hardcoded names"
  artifacts:
    - path: "src/components/QuestIntroduction.tsx"
      provides: "First quest intro detection"
      contains: "hasShownFirst|isFirstQuest"
    - path: "src/components/Game.tsx"
      provides: "Collapsible debug controls"
      contains: "useState.*false|debugExpanded|isDebugOpen"
    - path: "src/components/LevelUpCelebration.tsx"
      provides: "Color-based celebration messages"
      contains: "primaryColor|colors.primary"
  key_links:
    - from: "src/components/QuestIntroduction.tsx"
      to: "questStore.currentQuestIndex"
      via: "initial quest detection"
      pattern: "currentIndex === 0"
    - from: "src/components/LevelUpCelebration.tsx"
      to: "character.colors.primary"
      via: "message lookup by color"
      pattern: "character.*primary.*color|colors\\.primary"
---

<objective>
Close three tech debt items from the v1 milestone audit.

Purpose: Polish the player experience by fixing minor UX issues identified during prototype validation.
Output: Three small fixes that improve game start experience, reduce UI clutter, and make code more generalizable.
</objective>

<execution_context>
@/Users/godstemning/.claude/get-shit-done/workflows/execute-plan.md
@/Users/godstemning/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/components/QuestIntroduction.tsx
@src/components/Game.tsx
@src/components/LevelUpCelebration.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix first quest introduction popup</name>
  <files>src/components/QuestIntroduction.tsx</files>
  <action>
The current logic at line 23 checks `currentIndex > previousQuestIndex.current` which is false when both are 0 (initial game load or after reset).

Fix by adding a `hasShownFirst` ref that tracks whether we've shown the first quest intro:

1. Add `const hasShownFirst = useRef(false);` after the existing refs
2. Modify the useEffect condition to also trigger when:
   - `currentIndex === 0 && !hasShownFirst.current && quest` (first quest on load)
3. Set `hasShownFirst.current = true` when showing the first quest intro
4. Reset `hasShownFirst.current = false` when `currentIndex` goes back to 0 (game reset detection)

The key insight: On fresh load, `currentIndex` is 0 and `previousQuestIndex.current` is also 0, so `currentIndex > previousQuestIndex.current` is false. We need a separate flag for the initial case.

Also add a small delay (500ms) before showing the first quest intro to let the game UI render first.
  </action>
  <verify>
1. Open the game in browser (npm run dev)
2. On initial load, first quest "Morning Routine" introduction should appear after ~500ms
3. Click "Reset Game" in crisis epilogue (or manually reset via store)
4. First quest introduction should appear again after reset
  </verify>
  <done>First quest shows introduction popup on game start and after reset</done>
</task>

<task type="auto">
  <name>Task 2: Collapse debug controls by default</name>
  <files>src/components/Game.tsx</files>
  <action>
The debug controls section (lines 142-171) is always fully visible. Convert to a collapsible panel:

1. Add `import { useState } from 'react';` (already imported, just add useState to destructure)
2. Add `const [debugOpen, setDebugOpen] = useState(false);` near the top of the component
3. Wrap the debug panel content in a collapsible structure:
   - Header row with "Debug Controls" label and a toggle button (ChevronDown/ChevronUp from lucide-react)
   - Content only shows when `debugOpen` is true
4. Use AnimatePresence and motion.div for smooth expand/collapse animation (already imported)

The debug panel should:
- Show only the header "Debug Controls" with a collapse icon by default
- Expand to show the full controls when clicked
- Use consistent styling with other panels (card, card-body pattern)
  </action>
  <verify>
1. Open the game in browser
2. Debug Controls section should show only header with expand icon
3. Click header to expand - should show drain/restore buttons
4. Click again to collapse
  </verify>
  <done>Debug controls collapsed by default, expandable on click</done>
</task>

<task type="auto">
  <name>Task 3: Generalize celebration messages</name>
  <files>src/components/LevelUpCelebration.tsx</files>
  <action>
The `CELEBRATION_MESSAGES` object has hardcoded 'elling' and 'mother' keys. Refactor to use MTG colors:

1. Change the type from `Record<string, Record<SkillCategory, string[]>>` to `Record<MTGColor, Record<SkillCategory, string[]>>`
2. Replace 'elling' messages with 'blue' key (Blue personality = analytical, introverted)
3. Replace 'mother' messages with 'white' key (White personality = orderly, community-focused)
4. Add fallback messages for other colors:
   - 'red': Impulsive, passionate responses
   - 'green': Natural, growth-focused responses
   - 'black': Ambitious, self-focused responses
5. Update the message lookup (line 43) to use `character.colors.primary.color` instead of `levelUp.characterId`

Import MTGColor type from '../types/game'.

Example message mapping:
- blue: Contemplative, self-doubting but insightful
- white: Encouraging, community-oriented
- red: Excited, spontaneous
- green: Natural, accepting
- black: Proud, ambitious
  </action>
  <verify>
1. Open the game in browser
2. Train a skill to level up (use debug controls to manipulate if needed)
3. Verify celebration shows personality-appropriate message based on character's primary color
4. Message should NOT reference character by hardcoded name
  </verify>
  <done>Celebration messages use character's primary MTG color for personality, not hardcoded IDs</done>
</task>

</tasks>

<verification>
After all tasks:

1. Fresh page load:
   - [ ] First quest "Morning Routine" intro appears after short delay
   - [ ] Debug controls collapsed by default

2. Gameplay:
   - [ ] Debug controls expand/collapse smoothly
   - [ ] Level-up celebration shows color-appropriate message

3. Game reset (via epilogue):
   - [ ] First quest intro appears again
   - [ ] Debug controls remain collapsed

4. Code quality:
   - [ ] No hardcoded character IDs in LevelUpCelebration
   - [ ] QuestIntroduction handles both initial load and reset cases
</verification>

<success_criteria>
1. On game start or reset, first quest shows introduction popup
2. Debug controls are collapsed/hidden by default
3. Celebration messages work for any character name (generalized by MTG color)
</success_criteria>

<output>
After completion, create `.planning/phases/06-polish/06-01-SUMMARY.md`
</output>
