---
phase: 02-autonomous-behavior
plan: 03
type: execute
wave: 3
depends_on: ["02-02"]
files_modified:
  - src/components/CharacterSprite.tsx
  - src/components/ThoughtBubble.tsx
  - src/components/Game.tsx
autonomous: false

must_haves:
  truths:
    - "Characters visibly move across the game world to activity locations"
    - "Thought bubbles appear when characters are deciding"
    - "Thought bubble shows competing options then highlights winner"
    - "Elling gravitates toward Blue activities (reading, thinking)"
    - "Mother gravitates toward White/Green activities (cooking, cleaning)"
    - "Low overskudd characters show tired visual state"
  artifacts:
    - path: "src/components/ThoughtBubble.tsx"
      provides: "Decision visualization component"
      exports: ["ThoughtBubble"]
    - path: "src/components/CharacterSprite.tsx"
      provides: "Position-animated character with thought bubble integration"
      contains: "useSpring"
    - path: "src/components/Game.tsx"
      provides: "Spatial game world with activity locations"
      contains: "relative"
  key_links:
    - from: "src/components/CharacterSprite.tsx"
      to: "src/stores/CharacterStore.ts"
      via: "reads character.state, character.position"
      pattern: "character\\.state|character\\.position"
    - from: "src/components/ThoughtBubble.tsx"
      to: "src/types/game.ts"
      via: "uses ActivityScore type"
      pattern: "ActivityScore"
    - from: "src/components/Game.tsx"
      to: "src/components/CharacterSprite.tsx"
      via: "renders sprites with absolute positioning"
      pattern: "CharacterSprite"
---

<objective>
Build the visual layer for autonomous behavior: position-animated character sprites, thought bubble decision visualization, and a spatial game world where characters move to activity locations.

Purpose: Makes the autonomous behavior visible and understandable. Players should watch Elling deliberate (long thought bubble) then walk to books, while Mother decides quickly and heads to the kitchen.

Output: Working visual representation of character autonomy including movement animation, thought bubbles, and activity-driven positioning.
</objective>

<execution_context>
@/Users/godstemning/.claude/get-shit-done/workflows/execute-plan.md
@/Users/godstemning/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-autonomous-behavior/02-CONTEXT.md
@.planning/phases/02-autonomous-behavior/02-RESEARCH.md

# Phase 2 Plan 02 outputs
@src/stores/CharacterStore.ts
@src/types/game.ts

# Existing UI components to extend
@src/components/CharacterSprite.tsx
@src/components/Game.tsx
@src/components/CharacterPanel.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ThoughtBubble component</name>
  <files>src/components/ThoughtBubble.tsx</files>
  <action>
Create thought bubble component that visualizes the decision process per CONTEXT.md:
- Shows competing activity options (top 3 from pendingScores)
- After deliberation time, highlights the winner with color pulse
- Elling's bubble lingers longer (Blue = analysis)

Structure:
```typescript
import { motion, AnimatePresence } from 'motion/react';
import { useState, useEffect } from 'react';
import type { ActivityScore, MTGColor } from '../types/game';

interface ThoughtBubbleProps {
  scores: ActivityScore[];
  duration: number;  // ms - how long to show deliberation
  onComplete?: () => void;
}

export function ThoughtBubble({ scores, duration, onComplete }: ThoughtBubbleProps) {
  // ...
}
```

Visual design:
1. Comic-style bubble positioned above character (absolute, -top-16 or similar)
2. Show activity icons/initials for top 3 candidates
3. At 80% of duration, highlight winner (scale pulse + faint color background)
4. Winner's background color = hint of activity's primary color affinity (MTG color -> CSS color mapping)
5. Smooth enter/exit with motion (scale from 0.5, opacity from 0)
6. Bubble tail pointing down toward character

Color mapping helper (create inline or separate):
- white -> 'oklch(0.95 0.02 90)' (warm off-white)
- blue -> 'oklch(0.7 0.15 240)' (calm blue)
- black -> 'oklch(0.3 0.05 300)' (dark purple-gray)
- red -> 'oklch(0.7 0.2 25)' (warm red)
- green -> 'oklch(0.7 0.15 145)' (natural green)

Get primary color from activity's highest colorAffinity value. If no affinities, use neutral gray.

Use DaisyUI classes for styling (bg-base-100, rounded-2xl, shadow-lg).
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit`</verify>
  <done>ThoughtBubble component renders activity options, highlights winner after duration percentage, uses motion for animations</done>
</task>

<task type="auto">
  <name>Task 2: Update CharacterSprite with position animation and thought bubble</name>
  <files>src/components/CharacterSprite.tsx</files>
  <action>
Transform CharacterSprite from a static clickable card to a position-animated character with thought bubble integration.

Changes needed:

1. **Position animation with Motion useSpring:**
```typescript
import { motion, useSpring, AnimatePresence } from 'motion/react';
import { useEffect } from 'react';
```

Use useSpring for smooth position interpolation:
```typescript
const springX = useSpring(character.position.x, { stiffness: 50, damping: 20 });
const springY = useSpring(character.position.y, { stiffness: 50, damping: 20 });

useEffect(() => {
  springX.set(character.position.x);
  springY.set(character.position.y);
}, [character.position.x, character.position.y, springX, springY]);
```

2. **Absolute positioning:**
Change from flex-positioned to absolute-positioned within game world:
```tsx
<motion.div
  className="absolute"
  style={{ x: springX, y: springY }}
>
```

3. **Thought bubble integration:**
Show ThoughtBubble when character.state === 'deciding':
```tsx
<AnimatePresence>
  {character.state === 'deciding' && (
    <ThoughtBubble
      scores={character.pendingScores}
      duration={character.decisionDuration}
    />
  )}
</AnimatePresence>
```

4. **Visual state indicators:**
- When state === 'performing': show activity icon/name near character
- When overskudd < 40: add 'opacity-70' or similar tired visual
- When state === 'walking': optionally add subtle movement indicator

5. **Keep existing functionality:**
- onClick handler for selection
- isSelected ring styling
- Overskudd indicator (colored dot + percentage)
- Character name and avatar

The component should render as a motion.div with absolute positioning, containing the avatar, name, overskudd indicator, and conditionally the thought bubble.

Import ThoughtBubble from './ThoughtBubble'.
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit`. Run `npm run dev` and visually confirm characters have position animation.</verify>
  <done>CharacterSprite uses Motion springs for position, shows ThoughtBubble when deciding, has tired visual for low overskudd</done>
</task>

<task type="auto">
  <name>Task 3: Update Game component for spatial game world</name>
  <files>src/components/Game.tsx</files>
  <action>
Transform the game world from flex layout to a spatial canvas where characters move to activity locations.

Changes needed:

1. **Game world as relative positioned container:**
```tsx
<main className="card bg-base-200 shadow-xl mb-6">
  <div className="card-body">
    <h3 className="text-sm font-medium text-base-content/70 mb-4">Apartment</h3>

    {/* Spatial game world - relative container for absolute positioned children */}
    <div className="relative h-80 w-full bg-base-300 rounded-lg overflow-hidden">

      {/* Optional: Activity location markers */}
      {/* Can add subtle visual hints for kitchen, desk, etc. */}

      {/* Characters with absolute positioning */}
      {characterStore.allCharacters.map((character) => (
        <CharacterSprite
          key={character.id}
          character={character}
          isSelected={interactionStore.selectedCharacterId === character.id}
          onClick={() => interactionStore.selectCharacter(character.id)}
        />
      ))}
    </div>
  </div>
</main>
```

2. **Optional activity location hints:**
Add subtle visual markers for activity locations. Keep them minimal per CONTEXT.md ("Claude's discretion on visual treatment"):
```tsx
// Activity location markers (subtle)
<div className="absolute left-[300px] top-[200px] text-2xl opacity-30" title="Kitchen">

</div>
<div className="absolute left-[100px] top-[150px] text-2xl opacity-30" title="Desk">

</div>
// ... etc for other locations
```

Or keep it even simpler - just the relative container without explicit markers, letting character movement imply the space.

3. **Ensure proper z-indexing:**
- Activity markers: z-0 (background)
- Characters: z-10 (above markers)
- Thought bubbles: z-20 (above characters)

4. **Remove old flex layout:**
Replace the `flex gap-8 justify-center items-start` with the relative container approach.

The game world should feel like a top-down view of the apartment where characters walk around.
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit`. Run `npm run dev` and confirm characters appear in a spatial layout and can move.</verify>
  <done>Game component has spatial game world with relative positioning. Characters render at their position coordinates and move smoothly to activities.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete autonomous behavior system: Characters evaluate activities using Utility AI, deliberate via thought bubbles, walk to activity locations, and perform activities. Personality should be visible through activity preferences.</what-built>
  <how-to-verify>
1. Run `npm run dev` and open http://localhost:5173 (or whatever port Vite uses)
2. Watch without interacting for 2-3 minutes
3. Verify Phase 2 Success Criteria:

**Criterion 1: Elling gravitates toward Blue-aligned activities**
- Observe: Elling should frequently choose Reading or Thinking
- Thought bubble should show these options ranking high

**Criterion 2: Mother gravitates toward White/Green-aligned activities**
- Observe: Mother should frequently choose Cooking, Cleaning, or Check on Elling
- She should decide faster than Elling (shorter thought bubble duration)

**Criterion 3: Low overskudd triggers refusal**
- Speed up time or wait until overskudd drops below 40
- Character should show tired visual (reduced opacity)
- Below 20: should seek comfort behavior (Elling stares at window, Mother sits)

**Criterion 4: Observable personality differences**
- After 5 minutes: Can you articulate which activities each character prefers?
- Elling: intellectual, hesitant, drawn to books
- Mother: domestic, quick-acting, caretaking

**Visual checks:**
- Characters move smoothly (spring animation, not teleporting)
- Thought bubbles appear and show options
- Winner gets subtle color highlight
- Activity progress visible (optional - may show in character panel)
  </how-to-verify>
  <resume-signal>Type "approved" if all criteria pass, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
After all tasks complete (including checkpoint):
1. Characters move via spring animation to activity locations
2. Thought bubbles show during deciding state
3. Elling's thought bubble lingers ~2 seconds
4. Mother's thought bubble lasts ~0.8 seconds
5. Winner activity gets color-tinted highlight in bubble
6. Tired characters (overskudd < 40) have visual indicator
7. Characters perform different activities based on their MTG colors
8. Phase 2 success criteria validated by human observation
</verification>

<success_criteria>
- ThoughtBubble component shows top 3 activity options
- Winner gets highlighted after 80% of duration
- CharacterSprite uses Motion springs for x/y position
- Characters are absolutely positioned in relative game world
- Thought bubble appears when character.state === 'deciding'
- Human verifies personality differences are observable
- Human verifies refusal behavior works at low overskudd
</success_criteria>

<output>
After completion, create `.planning/phases/02-autonomous-behavior/02-03-SUMMARY.md`
</output>
