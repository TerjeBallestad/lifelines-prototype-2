---
phase: 02-autonomous-behavior
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/stores/CharacterStore.ts
  - src/types/game.ts
autonomous: true

must_haves:
  truths:
    - "Character has state property (idle/deciding/walking/performing)"
    - "Character has position that can change over time"
    - "Character evaluates activities when idle and cooldown elapsed"
    - "Character with low overskudd refuses activities and seeks comfort"
    - "Character walks toward activity location before performing"
  artifacts:
    - path: "src/stores/CharacterStore.ts"
      provides: "Extended Character class with state machine"
      contains: "state: CharacterState"
    - path: "src/types/game.ts"
      provides: "CharacterData extended with initialPosition"
      contains: "initialPosition"
  key_links:
    - from: "src/stores/CharacterStore.ts"
      to: "src/systems/UtilityAI.ts"
      via: "imports scoreActivities, selectActivity"
      pattern: "import.*scoreActivities.*from.*UtilityAI"
    - from: "src/stores/CharacterStore.ts"
      to: "src/data/activities.ts"
      via: "imports ACTIVITIES for scoring"
      pattern: "import.*ACTIVITIES.*from.*activities"
---

<objective>
Extend the Character class with a state machine (idle/deciding/walking/performing) and autonomous decision-making that uses the Utility AI to select activities based on personality.

Purpose: Makes characters act on their own. This is the core behavior system that transforms static characters into autonomous agents with observable personality differences.

Output: Character class with state machine, position tracking, autonomous decision cycle, and refusal behavior for low overskudd.
</objective>

<execution_context>
@/Users/godstemning/.claude/get-shit-done/workflows/execute-plan.md
@/Users/godstemning/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-autonomous-behavior/02-CONTEXT.md
@.planning/phases/02-autonomous-behavior/02-RESEARCH.md

# Phase 2 Plan 01 outputs (when available, otherwise use source files)
@src/types/game.ts
@src/data/activities.ts
@src/systems/UtilityAI.ts
@src/stores/CharacterStore.ts
@src/data/characters.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add initialPosition to CharacterData and character data</name>
  <files>src/types/game.ts, src/data/characters.ts</files>
  <action>
1. In `src/types/game.ts`, extend CharacterData interface:
```typescript
export interface CharacterData {
  id: string;
  name: string;
  colors: MTGColorProfile;
  initialNeeds: Needs;
  initialPosition?: { x: number; y: number }; // NEW: starting position
}
```

2. In `src/data/characters.ts`, add initial positions:
- Elling starts near the desk/reading area: `{ x: 100, y: 150 }`
- Mother starts near the kitchen: `{ x: 280, y: 180 }`

This separates them spatially so their movements are visible.
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit`</verify>
  <done>CharacterData has optional initialPosition field. Elling and Mother have different starting positions.</done>
</task>

<task type="auto">
  <name>Task 2: Extend Character class with state machine and autonomous behavior</name>
  <files>src/stores/CharacterStore.ts</files>
  <action>
Extend the existing Character class with state machine and decision logic from RESEARCH.md.

**New properties to add:**
```typescript
// State machine
state: CharacterState = 'idle';
position: { x: number; y: number };
currentActivity: Activity | null = null;  // Change from string | null
activityProgress: number = 0;             // 0-1 completion

// Decision state
pendingScores: ActivityScore[] = [];      // Top 3 for thought bubble display
decisionDuration: number;                 // Elling: 2000ms, Mother: 800ms
decisionStartTime: number = 0;            // When decision started

// Cooldowns
idleCooldown: number = 0;                 // Game-minutes until next decision
```

**New computed properties:**
```typescript
get shouldRefuse(): boolean {
  // From CONTEXT.md: below 20 = always refuse, 20-40 = gradual
  if (this.overskudd < 20) return true;
  if (this.overskudd < 40) {
    const refusalChance = (40 - this.overskudd) / 20;
    return Math.random() < refusalChance;
  }
  return false;
}

get comfortActivity(): Activity {
  // From CONTEXT.md: Elling stares out window, Mother sits quietly
  return ACTIVITIES.find(a =>
    a.isComfortBehavior &&
    (this.id === 'elling' ? a.id === 'stare_window' : a.id === 'sit_rest')
  )!;
}
```

**Constructor changes:**
- Initialize position from data.initialPosition or default `{ x: 100, y: 150 }`
- Set decisionDuration based on primary color: Blue = 2000ms, else 800ms
- Add new properties to makeAutoObservable exclusions as needed

**New update method (called each tick):**
```typescript
update(gameMinutes: number): void {
  this.updateNeeds(gameMinutes);  // Existing

  switch (this.state) {
    case 'idle':
      this.idleCooldown -= gameMinutes;
      if (this.idleCooldown <= 0) {
        this.startDecision();
      }
      break;
    case 'deciding':
      // Handled by setTimeout in startDecision
      break;
    case 'walking':
      this.updateWalking(gameMinutes);
      break;
    case 'performing':
      this.updatePerforming(gameMinutes);
      break;
  }
}
```

**startDecision method:**
- Check shouldRefuse - if true, go straight to walking toward comfortActivity
- Otherwise, call scoreActivities from UtilityAI
- Store top 3 in pendingScores, set state to 'deciding', record decisionStartTime
- Use setTimeout with decisionDuration to call completeDecision

**completeDecision method:**
- Guard: if state !== 'deciding', return early
- Call selectActivity from UtilityAI with pendingScores
- Set currentActivity to result, state to 'walking', clear pendingScores

**updateWalking method:**
- Calculate distance to currentActivity.location
- If distance < 5 pixels, arrive: set position to target, state to 'performing', activityProgress to 0
- Otherwise, move toward target:
  - Base speed: Blue personality = 30 px/game-min, else 50 px/game-min
  - Actual speed scales with overskudd (overskudd/100 * baseSpeed)
  - Update position.x and position.y proportionally

**updatePerforming method:**
- Progress rate = 1 / (duration * 60) per game-minute
- Increment activityProgress
- If activityProgress >= 1, call completeActivity

**completeActivity method:**
- Apply activity effects to needs (clamp 0-100)
- Reset: currentActivity = null, activityProgress = 0, state = 'idle'
- Set idleCooldown = 2 game-minutes

**CharacterStore.updateAll change:**
- Call character.update(gameMinutes) instead of character.updateNeeds(gameMinutes)

Import Activity, ActivityScore, CharacterState from '../types/game'.
Import scoreActivities, selectActivity from '../systems/UtilityAI'.
Import ACTIVITIES from '../data/activities'.
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit`. Run `npm run dev`, observe characters start making decisions (may need console.log to verify state transitions before UI is built).</verify>
  <done>Character class has state machine with idle/deciding/walking/performing states. Characters autonomously evaluate activities using Utility AI. Low overskudd triggers refusal and comfort seeking.</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npx tsc --noEmit` passes
2. Character has state, position, currentActivity, activityProgress, pendingScores properties
3. Character.update() is called each tick and processes state machine
4. When idle, character calls scoreActivities and enters deciding state
5. After decisionDuration, character selects activity and starts walking
6. Character with overskudd < 20 goes directly to comfort behavior
7. Walking updates position toward activity location
8. Performing increments progress and completes activity
</verification>

<success_criteria>
- Character.state cycles through idle -> deciding -> walking -> performing -> idle
- Elling deliberates ~2 seconds (2000ms), Mother deliberates ~0.8 seconds (800ms)
- Elling walks slower than Mother (Blue = 30 px/min base, White = 50 px/min base)
- Character with overskudd < 20 always seeks comfort activity
- Character with overskudd 20-40 sometimes refuses (gradual probability)
- Activity effects applied to needs on completion
- idleCooldown prevents instant re-decision (2 game-minutes gap)
</success_criteria>

<output>
After completion, create `.planning/phases/02-autonomous-behavior/02-02-SUMMARY.md`
</output>
