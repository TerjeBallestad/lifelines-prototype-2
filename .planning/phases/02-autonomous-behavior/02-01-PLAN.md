---
phase: 02-autonomous-behavior
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/types/game.ts
  - src/data/activities.ts
  - src/systems/UtilityAI.ts
autonomous: true

must_haves:
  truths:
    - "Activity type exists with color affinities and location"
    - "6-8 activities defined with distinct color profiles"
    - "Utility AI can score activities for a character"
    - "Blue-heavy activities score higher for Elling than Mother"
  artifacts:
    - path: "src/types/game.ts"
      provides: "Activity type, CharacterState type"
      contains: "interface Activity"
    - path: "src/data/activities.ts"
      provides: "Activity definitions with color affinities"
      exports: ["ACTIVITIES"]
    - path: "src/systems/UtilityAI.ts"
      provides: "Activity scoring and selection logic"
      exports: ["scoreActivities", "selectActivity"]
  key_links:
    - from: "src/systems/UtilityAI.ts"
      to: "src/types/game.ts"
      via: "imports Activity, MTGColorProfile types"
      pattern: "import.*Activity.*from.*types/game"
    - from: "src/data/activities.ts"
      to: "src/types/game.ts"
      via: "typed activity definitions"
      pattern: "Activity\\[\\]"
---

<objective>
Define activity types, create activity data with MTG color affinities, and implement the Utility AI scoring system for autonomous behavior.

Purpose: Provides the data foundation and scoring logic that drives character decision-making. Without this, characters cannot evaluate which activities match their personality.

Output: Type definitions for activities, 8 activity definitions with color affinities and spatial locations, and a working Utility AI scorer that prefers color-matched activities.
</objective>

<execution_context>
@/Users/godstemning/.claude/get-shit-done/workflows/execute-plan.md
@/Users/godstemning/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-autonomous-behavior/02-CONTEXT.md
@.planning/phases/02-autonomous-behavior/02-RESEARCH.md

# Existing code to extend
@src/types/game.ts
@src/data/characters.ts
@src/stores/CharacterStore.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Define Activity and CharacterState types</name>
  <files>src/types/game.ts</files>
  <action>
Extend the existing types file with:

1. Add CharacterState type:
```typescript
export type CharacterState = 'idle' | 'deciding' | 'walking' | 'performing';
```

2. Add Activity interface:
```typescript
export interface Activity {
  id: string;
  name: string;
  icon?: string;                                    // Emoji or single char for thought bubble
  colorAffinities: Partial<Record<MTGColor, number>>; // 0-1 per color
  location: { x: number; y: number };               // Spatial position in game world
  duration: number;                                 // Game hours to complete
  effects: {
    energy?: number;                                // Positive = restore, negative = consume
    social?: number;
    purpose?: number;
  };
  isComfortBehavior?: boolean;                      // For low-overskudd fallback
}
```

3. Add ActivityScore interface for the scoring system:
```typescript
export interface ActivityScore {
  activity: Activity;
  utility: number;      // 0-1 normalized total score
  colorMatch: number;   // How well activity colors match character
  needSatisfaction: number; // How much activity helps current needs
}
```

Keep all existing types intact. Add the new types at the end of the file.
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit`</verify>
  <done>Activity, CharacterState, and ActivityScore types exist in game.ts with correct structure</done>
</task>

<task type="auto">
  <name>Task 2: Create activity definitions data</name>
  <files>src/data/activities.ts</files>
  <action>
Create a new file with 8 activity definitions. From CONTEXT.md and RESEARCH.md:

Activities to define (with color affinities):
1. **Reading** - Blue 0.9 - Elling's ideal activity
2. **Deep Thought / Thinking** - Blue 0.8 - Pondering by window
3. **Cooking** - White 0.6, Green 0.5 - Mother's ideal activity
4. **Cleaning / Tidy Up** - White 0.8 - Domestic duty
5. **Check on Elling** - White 0.7, Green 0.3 - Mother's caretaking
6. **Watch TV** - No strong affinity (neutral)
7. **Use Phone** - No strong affinity (neutral)
8. **Rest** - Green 0.4 - Recovery activity

Plus 2 comfort behaviors (for low overskudd):
9. **Stare Out Window** - Blue 0.5, isComfortBehavior: true - Elling's comfort
10. **Sit Quietly** - White 0.3, isComfortBehavior: true - Mother's comfort

Location coordinates: Use a simple layout where x ranges 50-350 and y ranges 100-250.
- Kitchen area: x: 300, y: 200
- Desk/reading area: x: 100, y: 150
- Window area: x: 200, y: 100
- Living/TV area: x: 200, y: 180
- Rest area: x: 180, y: 220

Duration: Most activities 0.5-1 game hours. Rest activities shorter.

Effects: Reading/thinking cost energy but give purpose. Cooking costs more energy but gives purpose. Rest restores energy. Phone gives social.

Export as `ACTIVITIES: Activity[]` with proper typing from '../types/game'.
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit` and file exports ACTIVITIES array</verify>
  <done>8 regular activities + 2 comfort behaviors defined with color affinities, locations, durations, and effects</done>
</task>

<task type="auto">
  <name>Task 3: Implement Utility AI scoring system</name>
  <files>src/systems/UtilityAI.ts</files>
  <action>
Create new file `src/systems/UtilityAI.ts` implementing the scoring system from RESEARCH.md.

Functions to implement:

1. `calculateColorAffinity(characterColors: MTGColorProfile, activityColors: Partial<Record<MTGColor, number>>): number`
   - For each color in activityColors, get character's intensity for that color
   - Multiply character intensity by activity affinity
   - Normalize to 0-1
   - Return 0.5 (neutral) if activity has no color affinities

2. `calculateNeedSatisfaction(needs: Needs, effects: Activity['effects']): number`
   - Calculate how badly each need is needed (1 - current/100)
   - Weight by how much the activity restores that need
   - Normalize effects (energy/20, social/10, purpose/20)
   - Return 0.5 if no positive effects

3. `scoreActivities(character: Character, activities: Activity[]): ActivityScore[]`
   - Filter out comfort behaviors (isComfortBehavior: true)
   - For each activity, calculate colorMatch and needSatisfaction
   - Combine: utility = (colorMatch * 0.6) + (needSatisfaction * 0.4)
   - Return sorted by utility descending

4. `selectActivity(scores: ActivityScore[]): Activity`
   - Take candidates within 80% of best score, max 3
   - Weighted random selection based on utility scores
   - Return selected activity

Key formula (from RESEARCH.md):
```
utility = (colorMatch * 0.6) + (needSatisfaction * 0.4)
```

Color match dominates (60%) so personality drives behavior, but needs (40%) still matter.

Import Character type from '../stores/CharacterStore' and Activity types from '../types/game'.
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit`. Manually verify scoring by temporarily adding a test log in main.tsx that calls scoreActivities for Elling and Mother and logs top 3 activities for each - Blue activities should rank higher for Elling.</verify>
  <done>UtilityAI exports scoreActivities and selectActivity. Elling's top activities are Blue-aligned (reading, thinking). Mother's top activities are White/Green-aligned (cooking, cleaning).</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npx tsc --noEmit` passes with no errors
2. Activity type has all required fields (id, name, colorAffinities, location, duration, effects)
3. ACTIVITIES array has 10 items (8 regular + 2 comfort)
4. scoreActivities returns sorted ActivityScore[] with Blue activities ranking higher for Elling
5. selectActivity returns an Activity from weighted random selection
</verification>

<success_criteria>
- Activity type defined with colorAffinities as Partial<Record<MTGColor, number>>
- 8 regular activities + 2 comfort behaviors exported from data/activities.ts
- Reading/thinking have Blue 0.8-0.9 affinity
- Cooking/cleaning have White 0.6-0.8 affinity
- Utility AI scores Blue activities higher for Elling (Blue 1.0) than for Mother (White 0.7)
- selectActivity uses weighted random, not always picking #1
</success_criteria>

<output>
After completion, create `.planning/phases/02-autonomous-behavior/02-01-SUMMARY.md`
</output>
