---
phase: 04-quest-system
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/types/game.ts
  - src/data/quests.ts
  - src/stores/QuestStore.ts
  - src/stores/RootStore.ts
autonomous: true

must_haves:
  truths:
    - "Quest store tracks current quest index and completion state"
    - "Quest progress is computed reactively from ResourceStore and SkillStore values"
    - "Composite quest (morning routine) has custom completion logic"
  artifacts:
    - path: "src/types/game.ts"
      provides: "Quest and QuestType type definitions"
      contains: "Quest"
    - path: "src/data/quests.ts"
      provides: "3 quest definitions with completion criteria"
      exports: ["QUESTS", "getQuestById"]
    - path: "src/stores/QuestStore.ts"
      provides: "Quest state management with computed progress"
      exports: ["QuestStore"]
  key_links:
    - from: "src/stores/QuestStore.ts"
      to: "src/stores/ResourceStore.ts"
      via: "rootStore.resourceStore.getResource()"
      pattern: "resourceStore\\.getResource"
    - from: "src/stores/QuestStore.ts"
      to: "src/stores/SkillStore.ts"
      via: "rootStore.skillStore.getSkill()"
      pattern: "skillStore\\.getSkill"
    - from: "src/stores/RootStore.ts"
      to: "src/stores/QuestStore.ts"
      via: "constructor instantiation"
      pattern: "new QuestStore"
---

<objective>
Create quest data model and MobX store for tracking 3-quest sequence with reactive progress computation.

Purpose: Foundation for quest system - defines the 3 quests (morning routine, creativity production, phone skill) and creates QuestStore that computes progress by observing ResourceStore and SkillStore.

Output: Quest type definitions, quest data file, QuestStore integrated into RootStore.
</objective>

<execution_context>
@/Users/godstemning/.claude/get-shit-done/workflows/execute-plan.md
@/Users/godstemning/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-quest-system/04-CONTEXT.md
@.planning/phases/04-quest-system/04-RESEARCH.md

@src/types/game.ts
@src/stores/RootStore.ts
@src/stores/ResourceStore.ts
@src/stores/SkillStore.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Quest type definitions to game.ts</name>
  <files>src/types/game.ts</files>
  <action>
Add Quest type definitions at the end of game.ts:

```typescript
// Quest types for tracking player objectives
export type QuestType = 'resource' | 'skill' | 'composite';

export interface Quest {
  id: string;
  title: string;
  description: string;
  type: QuestType;
  // For resource quests
  resourceType?: ResourceType;
  targetAmount?: number;
  // For skill quests
  characterId?: string;
  skillCategory?: SkillCategory;
  targetLevel?: number;
  // For composite quests - custom completion check
  compositeConditions?: {
    resources?: { type: ResourceType; amount: number }[];
  };
}
```

Keep all existing types. Add Quest-related types after ActivityScore interface.
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit`</verify>
  <done>Quest and QuestType types exported from game.ts</done>
</task>

<task type="auto">
  <name>Task 2: Create quest data file with 3 quests</name>
  <files>src/data/quests.ts</files>
  <action>
Create new file src/data/quests.ts with 3 quest definitions:

```typescript
import type { Quest } from '../types/game';

/**
 * Quest definitions for "Before the Fall"
 *
 * 3 quests in fixed sequence:
 * 1. Morning Routine - composite quest (food + cleanliness thresholds)
 * 2. Creative Output - produce 100 creativity
 * 3. Stay Connected - train Phone skill to level 2
 */
export const QUESTS: Quest[] = [
  {
    id: 'morning-routine',
    title: 'Morning Routine',
    description: 'Get the day started - prepare some food and tidy up',
    type: 'composite',
    compositeConditions: {
      resources: [
        { type: 'food', amount: 20 },
        { type: 'cleanliness', amount: 15 },
      ],
    },
  },
  {
    id: 'creative-output',
    title: 'Creative Output',
    description: 'Produce 100 creativity through reading and thinking',
    type: 'resource',
    resourceType: 'creativity',
    targetAmount: 100,
  },
  {
    id: 'stay-connected',
    title: 'Stay Connected',
    description: 'Train Phone skill to level 2',
    type: 'skill',
    characterId: 'elling',
    skillCategory: 'Social',
    targetLevel: 2,
  },
];

export function getQuestById(id: string): Quest | undefined {
  return QUESTS.find(q => q.id === id);
}
```

Quest thresholds are calibrated for ~10-15 game-hours each:
- Morning routine: achievable with 1-2 cooking + cleaning activities
- Creative output: ~6-10 reading/thinking activities
- Phone skill: 100 XP needed (4-5 phone activities at ~20-25 XP each)
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit`</verify>
  <done>quests.ts exports QUESTS array with 3 quest definitions and getQuestById helper</done>
</task>

<task type="auto">
  <name>Task 3: Create QuestStore with reactive progress tracking</name>
  <files>src/stores/QuestStore.ts, src/stores/RootStore.ts</files>
  <action>
Create src/stores/QuestStore.ts:

```typescript
import { makeAutoObservable, computed } from 'mobx';
import type { Quest } from '../types/game';
import { QUESTS } from '../data/quests';
import type { RootStore } from './RootStore';

/**
 * QuestStore manages quest state and tracks progress reactively
 *
 * Key features:
 * - currentQuestIndex tracks which quest is active
 * - pendingCompletion holds completed quest for celebration modal
 * - Progress is COMPUTED from ResourceStore/SkillStore (not stored)
 */
export class QuestStore {
  currentQuestIndex: number = 0;
  pendingCompletion: Quest | null = null;

  readonly rootStore: RootStore;

  constructor(rootStore: RootStore) {
    this.rootStore = rootStore;
    makeAutoObservable(this, { rootStore: false });
  }

  /**
   * Current active quest (null if all quests complete)
   */
  get currentQuest(): Quest | null {
    return QUESTS[this.currentQuestIndex] ?? null;
  }

  /**
   * Check if all quests are complete
   */
  get allQuestsComplete(): boolean {
    return this.currentQuestIndex >= QUESTS.length;
  }

  /**
   * Computed: reactive progress 0-1 based on quest type
   * Automatically updates when ResourceStore or SkillStore changes
   */
  get currentQuestProgress(): number {
    const quest = this.currentQuest;
    if (!quest) return 0;

    switch (quest.type) {
      case 'resource':
        return this.getResourceQuestProgress(quest);
      case 'skill':
        return this.getSkillQuestProgress(quest);
      case 'composite':
        return this.getCompositeQuestProgress(quest);
      default:
        return 0;
    }
  }

  /**
   * Progress for resource-based quests
   */
  private getResourceQuestProgress(quest: Quest): number {
    if (!quest.resourceType || !quest.targetAmount) return 0;
    const current = this.rootStore.resourceStore.getResource(quest.resourceType);
    return Math.min(1, current / quest.targetAmount);
  }

  /**
   * Progress for skill-based quests
   */
  private getSkillQuestProgress(quest: Quest): number {
    if (!quest.characterId || !quest.skillCategory || !quest.targetLevel) return 0;
    const skill = this.rootStore.skillStore.getSkill(quest.characterId, quest.skillCategory);
    if (!skill) return 0;

    // If at or above target level, complete
    if (skill.level >= quest.targetLevel) return 1;

    // Otherwise, show progress within the target level
    // e.g., if target is level 2, and we're at level 1 with 50% progress to level 2,
    // that's 50% of the quest
    const levelsNeeded = quest.targetLevel - 1; // levels to gain from level 1
    const currentLevelGains = skill.level - 1;
    const levelFraction = currentLevelGains / levelsNeeded;
    const progressInCurrentLevel = skill.levelProgress / levelsNeeded;

    return Math.min(1, levelFraction + progressInCurrentLevel);
  }

  /**
   * Progress for composite quests (multiple conditions)
   */
  private getCompositeQuestProgress(quest: Quest): number {
    if (!quest.compositeConditions?.resources) return 0;

    const conditions = quest.compositeConditions.resources;
    let totalProgress = 0;

    for (const condition of conditions) {
      const current = this.rootStore.resourceStore.getResource(condition.type);
      const conditionProgress = Math.min(1, current / condition.amount);
      totalProgress += conditionProgress;
    }

    return totalProgress / conditions.length;
  }

  /**
   * Check if current quest is complete (progress >= 1)
   * Does NOT trigger if already showing completion modal
   */
  get isQuestComplete(): boolean {
    return this.currentQuestProgress >= 1 && !this.pendingCompletion && this.currentQuest !== null;
  }

  /**
   * Action: mark current quest as complete (triggers celebration)
   * Called by Game component when isQuestComplete becomes true
   */
  completeCurrentQuest(): void {
    if (this.currentQuest && !this.pendingCompletion) {
      this.pendingCompletion = this.currentQuest;
    }
  }

  /**
   * Action: advance to next quest after celebration dismissed
   */
  advanceQuest(): void {
    this.pendingCompletion = null;
    this.currentQuestIndex++;
  }

  /**
   * Total quests count
   */
  get totalQuests(): number {
    return QUESTS.length;
  }
}
```

Then update src/stores/RootStore.ts:
1. Add import: `import { QuestStore } from './QuestStore';`
2. Add property declaration: `questStore: QuestStore;`
3. In constructor, add: `this.questStore = new QuestStore(this);` (after resourceStore)
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit` and app starts: `npm run dev` (check no console errors)</verify>
  <done>QuestStore created with computed progress, integrated into RootStore</done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors: `npx tsc --noEmit`
2. App starts without runtime errors: `npm run dev`
3. In browser console, verify QuestStore exists:
   - Access `rootStore.questStore`
   - Check `rootStore.questStore.currentQuest` returns first quest
   - Check `rootStore.questStore.currentQuestProgress` returns a number 0-1
4. Produce some resources via activities and verify progress updates reactively
</verification>

<success_criteria>
- Quest types defined and exported from game.ts
- 3 quests defined in quests.ts with appropriate thresholds
- QuestStore computes progress reactively from ResourceStore/SkillStore
- QuestStore integrated into RootStore singleton
- No TypeScript or runtime errors
</success_criteria>

<output>
After completion, create `.planning/phases/04-quest-system/04-01-SUMMARY.md`
</output>
