---
phase: 04-quest-system
plan: 03
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/components/QuestCelebration.tsx
  - src/components/QuestIntroduction.tsx
  - src/components/Game.tsx
autonomous: true

must_haves:
  truths:
    - "Celebration popup appears when quest completes"
    - "Game pauses while celebration is displayed"
    - "Clicking celebration dismisses it and advances to next quest"
    - "Introduction popup briefly shows new quest after celebration"
  artifacts:
    - path: "src/components/QuestCelebration.tsx"
      provides: "Full-screen celebration modal for quest completion"
      exports: ["QuestCelebration"]
    - path: "src/components/QuestIntroduction.tsx"
      provides: "Brief popup introducing next quest"
      exports: ["QuestIntroduction"]
  key_links:
    - from: "src/components/QuestCelebration.tsx"
      to: "src/stores/QuestStore.ts"
      via: "questStore.pendingCompletion observation"
      pattern: "pendingCompletion"
    - from: "src/components/QuestCelebration.tsx"
      to: "src/stores/TimeStore.ts"
      via: "timeStore.pause() and timeStore.resume()"
      pattern: "timeStore\\.(pause|resume)"
    - from: "src/components/Game.tsx"
      to: "src/components/QuestCelebration.tsx"
      via: "import and render"
      pattern: "<QuestCelebration"
---

<objective>
Create quest completion celebration flow with popup modals and auto-chaining.

Purpose: Quest completion feedback - player sees celebration popup when quest completes, game pauses, then after dismissing, next quest is introduced. Creates satisfying completion moments that teach quest progression.

Output: QuestCelebration modal, QuestIntroduction popup, completion detection in Game.tsx.
</objective>

<execution_context>
@/Users/godstemning/.claude/get-shit-done/workflows/execute-plan.md
@/Users/godstemning/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-quest-system/04-CONTEXT.md
@.planning/phases/04-quest-system/04-RESEARCH.md
@.planning/phases/04-quest-system/04-01-SUMMARY.md

@src/components/LevelUpCelebration.tsx
@src/components/Game.tsx
@src/stores/QuestStore.ts
@src/stores/TimeStore.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create QuestCelebration modal component</name>
  <files>src/components/QuestCelebration.tsx</files>
  <action>
Create src/components/QuestCelebration.tsx following LevelUpCelebration pattern:

```typescript
import { useEffect } from 'react';
import { observer } from 'mobx-react-lite';
import { motion, AnimatePresence } from 'motion/react';
import { Trophy } from 'lucide-react';
import { useGameStore } from '../stores/RootStore';

// Celebration messages based on quest type
const QUEST_MESSAGES: Record<string, string[]> = {
  'morning-routine': [
    "A good start to the day!",
    "The basics are covered.",
    "Ready for what's next.",
  ],
  'creative-output': [
    "Ideas are flowing!",
    "Creativity unlocked.",
    "The mind is sharp.",
  ],
  'stay-connected': [
    "Connection established!",
    "The phone is a lifeline.",
    "Practice makes progress.",
  ],
};

/**
 * Full-screen celebration modal when quest completes
 * Pauses game while displayed, advances quest on dismiss
 */
export const QuestCelebration = observer(function QuestCelebration() {
  const { questStore, timeStore } = useGameStore();
  const completedQuest = questStore.pendingCompletion;

  // Pause game when celebration appears
  useEffect(() => {
    if (completedQuest) {
      timeStore.pause();
    }
  }, [completedQuest, timeStore]);

  if (!completedQuest) return null;

  const messages = QUEST_MESSAGES[completedQuest.id] ?? ["Quest complete!"];
  const message = messages[Math.floor(Math.random() * messages.length)];

  const handleDismiss = () => {
    questStore.advanceQuest();
    // Don't resume yet - let QuestIntroduction handle that
    // (or if no more quests, resume immediately)
    if (questStore.allQuestsComplete) {
      timeStore.resume();
    }
  };

  return (
    <AnimatePresence>
      <motion.div
        initial={{ opacity: 0 }}
        animate={{ opacity: 1 }}
        exit={{ opacity: 0 }}
        className="fixed inset-0 z-50 flex items-center justify-center bg-black/50"
        onClick={handleDismiss}
      >
        <motion.div
          initial={{ scale: 0.5, y: 50 }}
          animate={{ scale: 1, y: 0 }}
          exit={{ scale: 0.5, y: 50 }}
          className="bg-base-100 rounded-2xl p-8 shadow-2xl text-center max-w-sm"
          onClick={(e) => e.stopPropagation()}
        >
          {/* Trophy icon */}
          <motion.div
            initial={{ scale: 0, rotate: -180 }}
            animate={{ scale: 1, rotate: 0 }}
            transition={{ delay: 0.1, type: 'spring', stiffness: 200 }}
            className="text-6xl mb-4 inline-block"
          >
            <Trophy className="w-16 h-16 text-warning" />
          </motion.div>

          {/* Quest complete banner */}
          <motion.div
            initial={{ scale: 0 }}
            animate={{ scale: [0, 1.2, 1] }}
            transition={{ delay: 0.2, duration: 0.5 }}
            className="font-pixel text-2xl text-success mb-2"
          >
            QUEST COMPLETE!
          </motion.div>

          {/* Quest title */}
          <div className="text-lg font-bold mb-4">
            {completedQuest.title}
          </div>

          {/* Flavor message */}
          <motion.div
            initial={{ opacity: 0, y: 10 }}
            animate={{ opacity: 1, y: 0 }}
            transition={{ delay: 0.5 }}
            className="italic text-base-content/80 mb-4"
          >
            "{message}"
          </motion.div>

          {/* Quest progress indicator */}
          <div className="text-sm text-base-content/60 mb-4">
            Quest {questStore.currentQuestIndex + 1} of {questStore.totalQuests}
          </div>

          {/* Dismiss button */}
          <motion.button
            initial={{ opacity: 0 }}
            animate={{ opacity: 1 }}
            transition={{ delay: 0.7 }}
            className="btn btn-primary btn-wide"
            onClick={handleDismiss}
          >
            {questStore.currentQuestIndex < questStore.totalQuests - 1
              ? "Next Quest"
              : "Continue Playing"
            }
          </motion.button>

          {/* Tap hint */}
          <div className="text-xs opacity-50 mt-4">
            Game paused - click anywhere to continue
          </div>
        </motion.div>
      </motion.div>
    </AnimatePresence>
  );
});
```

Key features:
- Trophy icon with spring animation
- Quest complete banner with scale pop
- Shows quest title and flavor message
- Indicates quest progress (X of Y)
- Button shows "Next Quest" or "Continue Playing"
- Pauses game on appear, handles transition to next quest
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit`</verify>
  <done>QuestCelebration modal with animations and game pause</done>
</task>

<task type="auto">
  <name>Task 2: Create QuestIntroduction popup component</name>
  <files>src/components/QuestIntroduction.tsx</files>
  <action>
Create src/components/QuestIntroduction.tsx for brief next-quest introduction:

```typescript
import { useEffect, useState, useRef } from 'react';
import { observer } from 'mobx-react-lite';
import { motion, AnimatePresence } from 'motion/react';
import { Target } from 'lucide-react';
import { useGameStore } from '../stores/RootStore';

/**
 * Brief popup introducing the next quest after celebration dismissed
 * Auto-dismisses after a few seconds, doesn't pause game
 */
export const QuestIntroduction = observer(function QuestIntroduction() {
  const { questStore, timeStore } = useGameStore();
  const [showIntro, setShowIntro] = useState(false);
  const previousQuestIndex = useRef(questStore.currentQuestIndex);

  const quest = questStore.currentQuest;

  // Detect when quest index advances (after celebration dismissed)
  useEffect(() => {
    const currentIndex = questStore.currentQuestIndex;

    // If quest advanced and we have a new quest, show intro
    if (currentIndex > previousQuestIndex.current && quest) {
      setShowIntro(true);
      // Resume game when intro shows
      timeStore.resume();

      // Auto-dismiss after 3 seconds
      const timer = setTimeout(() => {
        setShowIntro(false);
      }, 3000);

      previousQuestIndex.current = currentIndex;
      return () => clearTimeout(timer);
    }

    previousQuestIndex.current = currentIndex;
  }, [questStore.currentQuestIndex, quest, timeStore]);

  // Manual dismiss
  const handleDismiss = () => {
    setShowIntro(false);
  };

  if (!showIntro || !quest) return null;

  return (
    <AnimatePresence>
      <motion.div
        initial={{ opacity: 0, y: -50, scale: 0.9 }}
        animate={{ opacity: 1, y: 0, scale: 1 }}
        exit={{ opacity: 0, y: -20, scale: 0.95 }}
        transition={{ type: 'spring', stiffness: 300, damping: 25 }}
        className="fixed top-4 left-1/2 -translate-x-1/2 z-40"
        onClick={handleDismiss}
      >
        <div className="bg-base-200 rounded-lg shadow-xl px-6 py-4 flex items-center gap-4 cursor-pointer border-2 border-primary/30">
          {/* Icon */}
          <div className="bg-primary/20 rounded-full p-2">
            <Target className="w-6 h-6 text-primary" />
          </div>

          {/* Content */}
          <div>
            <div className="text-xs text-primary font-medium uppercase tracking-wide">
              New Quest
            </div>
            <div className="font-bold text-lg">
              {quest.title}
            </div>
            <div className="text-sm text-base-content/70">
              {quest.description}
            </div>
          </div>

          {/* Progress indicator */}
          <div className="text-xs text-base-content/50 ml-4">
            {questStore.currentQuestIndex + 1}/{questStore.totalQuests}
          </div>
        </div>

        {/* Auto-dismiss hint */}
        <motion.div
          initial={{ width: '100%' }}
          animate={{ width: '0%' }}
          transition={{ duration: 3, ease: 'linear' }}
          className="h-0.5 bg-primary mt-1 rounded-full"
        />
      </motion.div>
    </AnimatePresence>
  );
});
```

Key features:
- Appears at top center of screen
- Spring animation on enter
- Shows new quest title and description
- Auto-dismisses after 3 seconds with progress indicator
- Click to dismiss early
- Does NOT pause game (allows play to continue)
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit`</verify>
  <done>QuestIntroduction popup with auto-dismiss functionality</done>
</task>

<task type="auto">
  <name>Task 3: Add completion detection and integrate popups into Game.tsx</name>
  <files>src/components/Game.tsx</files>
  <action>
Update src/components/Game.tsx to detect quest completion and render celebration components:

1. Add imports at top:
```typescript
import { QuestCelebration } from './QuestCelebration';
import { QuestIntroduction } from './QuestIntroduction';
```

2. Add useEffect inside the Game component (after existing hooks, before the return statement) to detect quest completion:

```typescript
// Detect quest completion and trigger celebration
useEffect(() => {
  if (store.questStore.isQuestComplete) {
    store.questStore.completeCurrentQuest();
  }
}, [store.questStore.isQuestComplete, store]);
```

Note: This uses the computed `isQuestComplete` which becomes true when progress >= 1 and no pending completion.

3. Add the celebration and introduction components inside the return, after QuestPanel (or near other overlay components):

```tsx
{/* Quest completion celebration */}
<QuestCelebration />

{/* Quest introduction popup */}
<QuestIntroduction />
```

The final component order should be:
- Main game content
- QuestPanel
- LevelUpCelebration
- QuestCelebration
- QuestIntroduction
- ActivityModal
  </action>
  <verify>
1. TypeScript compiles: `npx tsc --noEmit`
2. App starts: `npm run dev`
3. Complete a quest by producing enough resources
4. Celebration modal appears and game pauses
5. Click to dismiss, introduction popup shows briefly
6. Game resumes and next quest is active
  </verify>
  <done>Quest completion flow integrated into Game.tsx with celebration and introduction popups</done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors: `npx tsc --noEmit`
2. App starts: `npm run dev`
3. Play until first quest completes (morning routine needs food >= 20, cleanliness >= 15)
4. Celebration modal appears with trophy animation
5. Game is paused while celebration shows
6. Click "Next Quest" button or background
7. Introduction popup appears at top showing quest 2
8. After 3 seconds, intro auto-dismisses
9. Game resumes, quest panel shows quest 2 progress
10. Repeat for quest 2 and 3
11. After quest 3, celebration says "Continue Playing"
12. No introduction popup after final quest (game continues normally)
</verification>

<success_criteria>
- QuestCelebration appears when quest progress reaches 100%
- Game pauses during celebration (time stops, no character movement)
- Trophy animation plays on celebration
- Clicking celebration advances to next quest
- QuestIntroduction shows new quest briefly (3 seconds)
- Game resumes after intro appears
- After final quest, no intro, game continues
- All animations smooth and consistent with existing patterns
</success_criteria>

<output>
After completion, create `.planning/phases/04-quest-system/04-03-SUMMARY.md`
</output>
