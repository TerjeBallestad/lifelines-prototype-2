---
phase: 04-quest-system
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/components/QuestPanel.tsx
  - src/components/QuestProgress.tsx
  - src/components/Game.tsx
autonomous: true

must_haves:
  truths:
    - "Quest panel is visible on right side of screen"
    - "Panel can collapse to mini-view showing icon + progress percentage"
    - "Progress bar animates smoothly when resources/skills change"
    - "Progress bar shows 80%+ visual emphasis when near complete"
  artifacts:
    - path: "src/components/QuestPanel.tsx"
      provides: "Collapsible quest panel with expand/collapse state"
      exports: ["QuestPanel"]
    - path: "src/components/QuestProgress.tsx"
      provides: "Spring-animated progress bar with number overlay"
      exports: ["QuestProgress"]
  key_links:
    - from: "src/components/QuestPanel.tsx"
      to: "src/stores/QuestStore.ts"
      via: "useGameStore().questStore"
      pattern: "questStore"
    - from: "src/components/Game.tsx"
      to: "src/components/QuestPanel.tsx"
      via: "import and render"
      pattern: "<QuestPanel"
---

<objective>
Create collapsible quest panel UI with spring-animated progress bar.

Purpose: Visual quest tracking - player sees current objective and progress. Panel collapses for minimal footprint during gameplay but expands to show full details. Progress bar uses spring animation consistent with existing XP bar pattern.

Output: QuestPanel and QuestProgress components integrated into Game.tsx.
</objective>

<execution_context>
@/Users/godstemning/.claude/get-shit-done/workflows/execute-plan.md
@/Users/godstemning/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-quest-system/04-CONTEXT.md
@.planning/phases/04-quest-system/04-RESEARCH.md
@.planning/phases/04-quest-system/04-01-SUMMARY.md

@src/components/SkillProgress.tsx
@src/components/Game.tsx
@src/stores/QuestStore.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create QuestProgress component with spring animation</name>
  <files>src/components/QuestProgress.tsx</files>
  <action>
Create src/components/QuestProgress.tsx following the SkillProgress spring pattern:

```typescript
import { observer } from 'mobx-react-lite';
import { motion, useSpring, useTransform } from 'motion/react';
import clsx from 'clsx';

interface QuestProgressProps {
  progress: number;  // 0-1
  current?: number;  // Current value (e.g., 47)
  target?: number;   // Target value (e.g., 100)
  compact?: boolean;
}

/**
 * Spring-animated progress bar for quest tracking
 * Shows progress bar with optional number overlay (e.g., "47/100")
 * Visual emphasis at 80%+ progress (glow effect)
 */
export const QuestProgress = observer(function QuestProgress({
  progress,
  current,
  target,
  compact = false,
}: QuestProgressProps) {
  const springProgress = useSpring(progress, {
    stiffness: 100,
    damping: 20,
  });
  const widthPercent = useTransform(springProgress, v => `${Math.min(100, v * 100)}%`);

  const isNearComplete = progress >= 0.8;
  const isComplete = progress >= 1;

  if (compact) {
    return (
      <div className="flex items-center gap-2">
        <div className="flex-1 h-1.5 bg-base-300 rounded-full overflow-hidden">
          <motion.div
            className={clsx(
              "h-full transition-colors",
              isComplete ? "bg-success" : isNearComplete ? "bg-warning" : "bg-primary"
            )}
            style={{ width: widthPercent }}
          />
        </div>
        <span className="text-xs font-medium min-w-[3ch] text-right">
          {Math.floor(progress * 100)}%
        </span>
      </div>
    );
  }

  return (
    <div className="space-y-1">
      {/* Progress bar */}
      <div className="h-3 bg-base-300 rounded-full overflow-hidden relative">
        <motion.div
          className={clsx(
            "h-full transition-all",
            isComplete
              ? "bg-success"
              : isNearComplete
                ? "bg-gradient-to-r from-warning to-success shadow-lg shadow-warning/30"
                : "bg-gradient-to-r from-primary to-secondary",
            isNearComplete && !isComplete && "animate-pulse"
          )}
          style={{ width: widthPercent }}
        />

        {/* Number overlay */}
        {current !== undefined && target !== undefined && (
          <div className="absolute inset-0 flex items-center justify-center">
            <span className={clsx(
              "text-xs font-bold",
              progress > 0.5 ? "text-base-100" : "text-base-content/70"
            )}>
              {current}/{target}
            </span>
          </div>
        )}
      </div>

      {/* Percentage below for non-compact */}
      {(current === undefined || target === undefined) && (
        <div className="text-xs text-right text-base-content/70">
          {Math.floor(progress * 100)}%
        </div>
      )}
    </div>
  );
});
```

Key features:
- Spring animation (stiffness 100, damping 20) matches SkillProgress
- 80%+ progress shows warning color + pulse animation
- 100% shows success color
- Number overlay when current/target provided
- Max width clamped to 100% to prevent overshoot display issues
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit`</verify>
  <done>QuestProgress component with spring animation and 80%+ visual emphasis</done>
</task>

<task type="auto">
  <name>Task 2: Create QuestPanel component with collapse/expand</name>
  <files>src/components/QuestPanel.tsx</files>
  <action>
Create src/components/QuestPanel.tsx:

```typescript
import { useState } from 'react';
import { observer } from 'mobx-react-lite';
import { motion, AnimatePresence } from 'motion/react';
import { ChevronLeft, ChevronRight, Target, CheckCircle } from 'lucide-react';
import { useGameStore } from '../stores/RootStore';
import { QuestProgress } from './QuestProgress';

/**
 * Collapsible quest panel on right side of screen
 *
 * Collapsed: icon + mini progress bar + percentage
 * Expanded: full quest title, description, and detailed progress
 */
export const QuestPanel = observer(function QuestPanel() {
  const [isExpanded, setIsExpanded] = useState(false);
  const { questStore, resourceStore, skillStore } = useGameStore();

  const quest = questStore.currentQuest;
  const progress = questStore.currentQuestProgress;

  // Calculate current/target values for display
  const getProgressValues = (): { current: number; target: number } | null => {
    if (!quest) return null;

    switch (quest.type) {
      case 'resource':
        if (!quest.resourceType || !quest.targetAmount) return null;
        return {
          current: Math.floor(resourceStore.getResource(quest.resourceType)),
          target: quest.targetAmount,
        };
      case 'skill':
        if (!quest.characterId || !quest.skillCategory || !quest.targetLevel) return null;
        const skill = skillStore.getSkill(quest.characterId, quest.skillCategory);
        if (!skill) return null;
        return {
          current: skill.level,
          target: quest.targetLevel,
        };
      case 'composite':
        // For composite, just show percentage
        return null;
      default:
        return null;
    }
  };

  const progressValues = getProgressValues();

  // All quests complete state
  if (questStore.allQuestsComplete) {
    return (
      <div className="fixed right-4 top-1/2 -translate-y-1/2 z-40">
        <div className="bg-base-200 rounded-lg p-3 shadow-lg">
          <div className="flex items-center gap-2 text-success">
            <CheckCircle className="w-5 h-5" />
            <span className="text-sm font-medium">All quests complete!</span>
          </div>
        </div>
      </div>
    );
  }

  // No active quest
  if (!quest) return null;

  return (
    <div className="fixed right-4 top-1/2 -translate-y-1/2 z-40">
      <AnimatePresence mode="wait">
        {isExpanded ? (
          // Expanded view
          <motion.div
            key="expanded"
            initial={{ width: 64, opacity: 0 }}
            animate={{ width: 288, opacity: 1 }}
            exit={{ width: 64, opacity: 0 }}
            transition={{ type: 'spring', stiffness: 300, damping: 30 }}
            className="bg-base-200 rounded-lg shadow-lg overflow-hidden"
          >
            <div className="p-4">
              {/* Header with collapse button */}
              <div className="flex items-start justify-between mb-3">
                <div className="flex items-center gap-2">
                  <Target className="w-5 h-5 text-primary" />
                  <span className="text-xs text-base-content/60 uppercase tracking-wide">
                    Quest {questStore.currentQuestIndex + 1}/{questStore.totalQuests}
                  </span>
                </div>
                <button
                  onClick={() => setIsExpanded(false)}
                  className="btn btn-ghost btn-xs btn-circle"
                >
                  <ChevronRight className="w-4 h-4" />
                </button>
              </div>

              {/* Quest title and description */}
              <h3 className="font-bold text-lg mb-1">{quest.title}</h3>
              <p className="text-sm text-base-content/70 mb-4">
                {quest.description}
              </p>

              {/* Progress bar */}
              <QuestProgress
                progress={progress}
                current={progressValues?.current}
                target={progressValues?.target}
              />
            </div>
          </motion.div>
        ) : (
          // Collapsed view
          <motion.div
            key="collapsed"
            initial={{ width: 288, opacity: 0 }}
            animate={{ width: 64, opacity: 1 }}
            exit={{ width: 288, opacity: 0 }}
            transition={{ type: 'spring', stiffness: 300, damping: 30 }}
            className="bg-base-200 rounded-lg shadow-lg cursor-pointer"
            onClick={() => setIsExpanded(true)}
          >
            <div className="p-3 flex flex-col items-center gap-2">
              {/* Quest icon */}
              <Target className="w-6 h-6 text-primary" />

              {/* Mini progress */}
              <div className="w-full">
                <QuestProgress progress={progress} compact />
              </div>

              {/* Expand hint */}
              <ChevronLeft className="w-4 h-4 text-base-content/40" />
            </div>
          </motion.div>
        )}
      </AnimatePresence>
    </div>
  );
});
```

Key features:
- Fixed position on right side, vertically centered
- Spring animation for expand/collapse transition
- Collapsed: target icon + compact progress + chevron hint
- Expanded: quest number, title, description, full progress bar
- Shows "All quests complete!" when done
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit`</verify>
  <done>QuestPanel component with collapse/expand functionality</done>
</task>

<task type="auto">
  <name>Task 3: Integrate QuestPanel into Game.tsx</name>
  <files>src/components/Game.tsx</files>
  <action>
Update src/components/Game.tsx to include QuestPanel:

1. Add import at top:
```typescript
import { QuestPanel } from './QuestPanel';
```

2. Add QuestPanel component inside the main return, after ActivityModal (at the end of the component, just before the closing fragment or div):

```tsx
{/* Quest panel (right side) */}
<QuestPanel />
```

The QuestPanel is fixed-position so it can be placed anywhere in the component tree, but placing it near other overlays (LevelUpCelebration, ActivityModal) keeps related components together.
  </action>
  <verify>
1. TypeScript compiles: `npx tsc --noEmit`
2. App starts: `npm run dev`
3. Quest panel visible on right side of screen
4. Panel expands/collapses on click
  </verify>
  <done>QuestPanel integrated into Game.tsx, visible and interactive</done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors: `npx tsc --noEmit`
2. App starts and quest panel is visible on right side: `npm run dev`
3. Click panel to expand - shows quest title, description, progress bar
4. Click collapse button to minimize - shows icon + mini progress
5. Complete some activities that produce resources
6. Observe progress bar animating smoothly as resources accumulate
7. When progress reaches 80%+, observe visual emphasis (pulse/glow)
</verification>

<success_criteria>
- QuestPanel renders on right side of screen
- Panel collapses to icon + percentage, expands to full details
- Progress bar animates with spring physics
- Progress bar shows number overlay for resource/skill quests
- 80%+ progress shows visual emphasis (pulse animation)
- Panel does not block game world interaction
</success_criteria>

<output>
After completion, create `.planning/phases/04-quest-system/04-02-SUMMARY.md`
</output>
