---
phase: 03-activity-loop
plan: 03
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/components/FloatingNumber.tsx
  - src/components/FloatingNumberPool.tsx
  - src/components/ResourceBar.tsx
  - src/components/Game.tsx
  - src/index.css
autonomous: true

must_haves:
  truths:
    - "Completing an activity shows floating numbers rising from character"
    - "Floating numbers use pixel font and fade out as they rise"
    - "Resource bar at top of screen shows current resource counts"
    - "Resource counters pulse when receiving new values"
  artifacts:
    - path: "src/components/FloatingNumber.tsx"
      provides: "Animated floating number component"
      min_lines: 30
    - path: "src/components/FloatingNumberPool.tsx"
      provides: "Object pool manager for floating numbers"
      exports: ["FloatingNumberPool", "useFloatingNumbers"]
    - path: "src/components/ResourceBar.tsx"
      provides: "Top bar showing all resource counts"
      min_lines: 30
    - path: "src/index.css"
      provides: "Pixel font import and utility classes"
      contains: "Press Start 2P|font-pixel"
  key_links:
    - from: "src/components/Game.tsx"
      to: "src/components/ResourceBar.tsx"
      via: "component rendering"
      pattern: "<ResourceBar"
    - from: "src/components/FloatingNumberPool.tsx"
      to: "src/stores/CharacterStore.ts"
      via: "lastActivityResult observation"
      pattern: "lastActivityResult"
---

<objective>
Create the visual feedback system for activity completion with floating numbers and resource tracking.

Purpose: This is the "juice" - arcade-style feedback that makes activities feel satisfying. Floating numbers pop up from characters, and resource counters in the top bar pulse when receiving values.

Output: FloatingNumber component, FloatingNumberPool manager, ResourceBar component, pixel font integration.
</objective>

<execution_context>
@/Users/godstemning/.claude/get-shit-done/workflows/execute-plan.md
@/Users/godstemning/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-activity-loop/03-CONTEXT.md
@.planning/phases/03-activity-loop/03-RESEARCH.md
@.planning/phases/03-activity-loop/03-01-SUMMARY.md

@src/components/Game.tsx
@src/components/CharacterSprite.tsx
@src/stores/ResourceStore.ts
@src/types/game.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add pixel font and CSS utilities</name>
  <files>src/index.css</files>
  <action>
Add to src/index.css (at the top, before other styles):

```css
/* Pixel font for game feedback */
@import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

/* Utility class for pixel font */
.font-pixel {
  font-family: 'Press Start 2P', cursive;
}

/* Floating number styles */
.floating-number {
  font-family: 'Press Start 2P', cursive;
  font-size: 14px;
  text-shadow: 2px 2px 0 rgba(0, 0, 0, 0.5);
  pointer-events: none;
  user-select: none;
}

.floating-number-positive {
  color: #ffd700; /* Gold for positive */
}

.floating-number-negative {
  color: #ff4444; /* Red for negative */
}

.floating-number-critical {
  color: #00ff88; /* Bright green for critical */
  font-size: 18px;
}

/* Resource counter pulse animation */
@keyframes resource-pulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.15); }
}

.resource-pulse {
  animation: resource-pulse 0.3s ease-out;
}
```
  </action>
  <verify>
Run `npm run dev`, open browser, inspect elements - font-pixel class should apply Press Start 2P font.
  </verify>
  <done>
Pixel font imported, utility classes defined for floating numbers and pulse animation.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create FloatingNumber component and pool manager</name>
  <files>src/components/FloatingNumber.tsx, src/components/FloatingNumberPool.tsx</files>
  <action>
Create src/components/FloatingNumber.tsx:

```typescript
import { motion, useMotionValue, animate } from 'motion/react';
import { useEffect } from 'react';

interface FloatingNumberProps {
  value: number;
  x: number;
  y: number;
  critical?: boolean;
  onComplete: () => void;
}

/**
 * Animated floating number that rises and fades
 * Uses motion values to avoid React re-renders during animation
 */
export function FloatingNumber({ value, x, y, critical, onComplete }: FloatingNumberProps) {
  const opacity = useMotionValue(1);
  const posY = useMotionValue(0);

  useEffect(() => {
    // Animate upward 60px over 1 second
    const yControls = animate(posY, -60, {
      duration: 1,
      ease: 'easeOut',
    });

    // Fade out starting at 0.5s
    const opacityControls = animate(opacity, 0, {
      duration: 0.5,
      delay: 0.5,
      ease: 'easeIn',
    });

    // Cleanup after animation
    const timer = setTimeout(onComplete, 1000);

    return () => {
      yControls.stop();
      opacityControls.stop();
      clearTimeout(timer);
    };
  }, [opacity, posY, onComplete]);

  const isPositive = value >= 0;
  const displayValue = isPositive ? `+${value}` : `${value}`;

  const colorClass = critical
    ? 'floating-number-critical'
    : isPositive
      ? 'floating-number-positive'
      : 'floating-number-negative';

  return (
    <motion.div
      className={`floating-number ${colorClass} absolute`}
      style={{
        left: x,
        top: y,
        y: posY,
        opacity,
      }}
    >
      {displayValue}
      {critical && ' â˜…'}
    </motion.div>
  );
}
```

Create src/components/FloatingNumberPool.tsx:

```typescript
import { useState, useCallback, useEffect } from 'react';
import { observer } from 'mobx-react-lite';
import { reaction } from 'mobx';
import { FloatingNumber } from './FloatingNumber';
import { useGameStore } from '../stores/RootStore';
import type { ResourceType } from '../types/game';

interface FloatingNumberData {
  id: string;
  value: number;
  x: number;
  y: number;
  critical: boolean;
  resource: ResourceType;
}

/**
 * Manages a pool of floating numbers to prevent DOM accumulation
 * Watches character lastActivityResult and spawns numbers accordingly
 */
export const FloatingNumberPool = observer(function FloatingNumberPool() {
  const { characterStore } = useGameStore();
  const [numbers, setNumbers] = useState<FloatingNumberData[]>([]);

  const spawnNumber = useCallback((
    value: number,
    x: number,
    y: number,
    resource: ResourceType,
    critical: boolean = false
  ) => {
    const id = crypto.randomUUID();
    setNumbers(prev => [...prev, { id, value, x, y, resource, critical }]);
  }, []);

  const removeNumber = useCallback((id: string) => {
    setNumbers(prev => prev.filter(n => n.id !== id));
  }, []);

  // Watch all characters for activity completion
  useEffect(() => {
    const disposers = characterStore.allCharacters.map(character =>
      reaction(
        () => character.lastActivityResult,
        (result) => {
          if (!result) return;

          // Spawn floating numbers for each output
          result.outputs.forEach((output, index) => {
            // Stagger slightly for multiple outputs
            setTimeout(() => {
              spawnNumber(
                output.amount,
                character.position.x + 20,
                character.position.y - 20 - (index * 25),
                output.resource,
                result.critical
              );
            }, index * 100);
          });

          // Clear the result after spawning numbers
          setTimeout(() => character.clearLastActivityResult(), 200);
        }
      )
    );

    return () => disposers.forEach(d => d());
  }, [characterStore.allCharacters, spawnNumber]);

  return (
    <>
      {numbers.map(num => (
        <FloatingNumber
          key={num.id}
          value={num.value}
          x={num.x}
          y={num.y}
          critical={num.critical}
          onComplete={() => removeNumber(num.id)}
        />
      ))}
    </>
  );
});
```
  </action>
  <verify>
`npx tsc --noEmit` passes. Components render without errors when imported into Game.tsx.
  </verify>
  <done>
FloatingNumber animates with motion values.
FloatingNumberPool watches characters and spawns numbers on activity completion.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create ResourceBar and integrate into Game</name>
  <files>src/components/ResourceBar.tsx, src/components/Game.tsx</files>
  <action>
Create src/components/ResourceBar.tsx:

```typescript
import { observer } from 'mobx-react-lite';
import { useGameStore } from '../stores/RootStore';
import type { ResourceType } from '../types/game';
import { useState, useEffect, useRef } from 'react';

// Resource display configuration
const RESOURCE_CONFIG: Record<ResourceType, { icon: string; label: string; color: string }> = {
  creativity: { icon: 'âœ¨', label: 'Creativity', color: 'text-purple-400' },
  food: { icon: 'ðŸ²', label: 'Food', color: 'text-orange-400' },
  cleanliness: { icon: 'ðŸ§¼', label: 'Clean', color: 'text-cyan-400' },
  comfort: { icon: 'ðŸ›‹ï¸', label: 'Comfort', color: 'text-green-400' },
  connection: { icon: 'ðŸ’¬', label: 'Connection', color: 'text-pink-400' },
  progress: { icon: 'ðŸ“ˆ', label: 'Progress', color: 'text-yellow-400' },
};

interface ResourceCounterProps {
  type: ResourceType;
  value: number;
}

const ResourceCounter = observer(function ResourceCounter({ type, value }: ResourceCounterProps) {
  const config = RESOURCE_CONFIG[type];
  const [isPulsing, setIsPulsing] = useState(false);
  const prevValueRef = useRef(value);

  // Trigger pulse animation when value increases
  useEffect(() => {
    if (value > prevValueRef.current) {
      setIsPulsing(true);
      const timer = setTimeout(() => setIsPulsing(false), 300);
      prevValueRef.current = value;
      return () => clearTimeout(timer);
    }
    prevValueRef.current = value;
  }, [value]);

  return (
    <div
      className={`flex items-center gap-1 px-2 py-1 rounded bg-base-300 ${isPulsing ? 'resource-pulse' : ''}`}
    >
      <span className="text-lg">{config.icon}</span>
      <span className={`font-pixel text-xs ${config.color}`}>{value}</span>
    </div>
  );
});

/**
 * Resource bar showing all global resource counts
 * Displays at top of game screen
 */
export const ResourceBar = observer(function ResourceBar() {
  const { resourceStore } = useGameStore();

  const resourceTypes: ResourceType[] = [
    'creativity', 'food', 'cleanliness', 'comfort', 'connection', 'progress'
  ];

  return (
    <div className="flex flex-wrap gap-2 p-2 bg-base-200 rounded-lg">
      {resourceTypes.map(type => (
        <ResourceCounter
          key={type}
          type={type}
          value={resourceStore.getResource(type)}
        />
      ))}
    </div>
  );
});
```

Update src/components/Game.tsx:

1. Import ResourceBar and FloatingNumberPool:
```typescript
import { ResourceBar } from './ResourceBar';
import { FloatingNumberPool } from './FloatingNumberPool';
```

2. Add ResourceBar after TimeDisplay in header section:
```tsx
<header className="mb-6">
  <h1 className="mb-4 text-2xl font-bold">Before the Fall</h1>
  <TimeDisplay />
  <div className="mt-4">
    <ResourceBar />
  </div>
</header>
```

3. Add FloatingNumberPool inside the spatial game world container (after the characters):
```tsx
<div className="bg-base-300 relative h-80 w-full overflow-hidden rounded-lg">
  {/* Activity location markers */}
  {/* ... existing markers ... */}

  {/* Characters */}
  {/* ... existing characters ... */}

  {/* Floating numbers overlay */}
  <FloatingNumberPool />
</div>
```
  </action>
  <verify>
1. `npm run dev` starts without errors
2. Resource bar visible below time display
3. Let character complete activity - floating number appears and rises
4. Resource counter pulses when value increases
  </verify>
  <done>
ResourceBar displays all 6 resources with pulse animation.
FloatingNumberPool spawns numbers on activity completion.
Game.tsx integrates both components.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no type errors
2. `npm run dev` starts without errors
3. Resource bar visible at top of game
4. Let Elling complete reading activity:
   - Floating "+15" (or similar) appears above character
   - Number rises and fades over 1 second
   - Creativity counter in resource bar pulses and increases
5. On critical success (may need to wait for RNG):
   - Number shows â˜… symbol
   - Number is green colored
</verification>

<success_criteria>
- Pixel font loads and applies correctly
- Floating numbers animate smoothly (rise + fade)
- Resource bar shows all 6 resource types
- Resource counters pulse when receiving new values
- Multiple outputs from one activity spawn staggered numbers
</success_criteria>

<output>
After completion, create `.planning/phases/03-activity-loop/03-03-SUMMARY.md`
</output>
