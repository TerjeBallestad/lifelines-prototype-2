---
phase: 03-activity-loop
plan: 05
type: execute
wave: 3
depends_on: ["03-02", "03-03"]
files_modified:
  - src/components/SkillProgress.tsx
  - src/components/LevelUpCelebration.tsx
  - src/components/CharacterPanel.tsx
  - src/stores/SkillStore.ts
autonomous: false

must_haves:
  truths:
    - "Player can see character's skill levels and XP progress"
    - "Level-up triggers visible celebration with character speech"
    - "Skill progress bar fills as XP accumulates"
    - "Activity completion feels satisfying with combined feedback"
  artifacts:
    - path: "src/components/SkillProgress.tsx"
      provides: "Skill display with XP bar and level indicator"
      min_lines: 40
    - path: "src/components/LevelUpCelebration.tsx"
      provides: "Animated level-up notification"
      min_lines: 30
    - path: "src/components/CharacterPanel.tsx"
      provides: "Extended panel showing skills"
      contains: "SkillProgress"
  key_links:
    - from: "src/components/CharacterPanel.tsx"
      to: "src/components/SkillProgress.tsx"
      via: "component rendering"
      pattern: "<SkillProgress"
    - from: "src/stores/SkillStore.ts"
      to: "level-up event"
      via: "observable level change"
      pattern: "onLevelUp|levelUpEvent"
---

<objective>
Add skill progression UI and level-up celebration for satisfying feedback loop.

Purpose: This completes the "juice" for Phase 3. Players need to see skills improving and feel rewarded when leveling up. This creates the satisfying progression loop that makes the game fun to watch.

Output: SkillProgress component, LevelUpCelebration component, extended CharacterPanel with skills display.
</objective>

<execution_context>
@/Users/godstemning/.claude/get-shit-done/workflows/execute-plan.md
@/Users/godstemning/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-activity-loop/03-CONTEXT.md
@.planning/phases/03-activity-loop/03-RESEARCH.md
@.planning/phases/03-activity-loop/03-02-SUMMARY.md
@.planning/phases/03-activity-loop/03-03-SUMMARY.md

@src/components/CharacterPanel.tsx
@src/stores/SkillStore.ts
@src/data/skills.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add level-up event tracking to SkillStore</name>
  <files>src/stores/SkillStore.ts</files>
  <action>
Update CharacterSkill class in SkillStore.ts to track level-ups:

1. Add observable for pending level-up notification:
```typescript
pendingLevelUp: { skill: SkillCategory; newLevel: number } | null = null;
```

2. Modify grantXP to detect level-ups:
```typescript
grantXP(amount: number): void {
  const oldLevel = this.level;
  this.xp += amount;
  const newLevel = this.level;

  if (newLevel > oldLevel) {
    this.pendingLevelUp = { skill: this.category, newLevel };
  }
}
```

3. Add method to clear level-up notification:
```typescript
clearLevelUp(): void {
  this.pendingLevelUp = null;
}
```

Update SkillStore class:

1. Add computed to check if any character has pending level-up:
```typescript
get anyPendingLevelUp(): { characterId: string; skill: SkillCategory; newLevel: number } | null {
  for (const [characterId, skills] of this.characterSkills) {
    for (const [category, skill] of skills) {
      if (skill.pendingLevelUp) {
        return {
          characterId,
          skill: category,
          newLevel: skill.pendingLevelUp.newLevel,
        };
      }
    }
  }
  return null;
}
```

2. Add method to clear specific character's level-up:
```typescript
clearLevelUp(characterId: string, category: SkillCategory): void {
  const skill = this.getSkill(characterId, category);
  if (skill) {
    skill.clearLevelUp();
  }
}
```
  </action>
  <verify>
`npx tsc --noEmit` passes. SkillStore tracks pending level-ups.
  </verify>
  <done>
Level-up events tracked on CharacterSkill.
SkillStore provides anyPendingLevelUp computed for UI to observe.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create SkillProgress and LevelUpCelebration components</name>
  <files>src/components/SkillProgress.tsx, src/components/LevelUpCelebration.tsx</files>
  <action>
Create src/components/SkillProgress.tsx:

```typescript
import { observer } from 'mobx-react-lite';
import { motion, useSpring, useTransform } from 'motion/react';
import type { CharacterSkill } from '../stores/SkillStore';
import type { SkillCategory } from '../types/game';

// Skill category icons
const SKILL_ICONS: Record<SkillCategory, string> = {
  Practical: 'üîß',
  Creative: 'üé®',
  Social: 'üí¨',
  Technical: '‚öôÔ∏è',
};

interface SkillProgressProps {
  skill: CharacterSkill;
  compact?: boolean;
}

/**
 * Displays skill level and XP progress bar
 */
export const SkillProgress = observer(function SkillProgress({
  skill,
  compact = false,
}: SkillProgressProps) {
  const springProgress = useSpring(skill.levelProgress, {
    stiffness: 100,
    damping: 20,
  });
  const widthPercent = useTransform(springProgress, v => `${v * 100}%`);

  if (compact) {
    return (
      <div className="flex items-center gap-2">
        <span>{SKILL_ICONS[skill.category]}</span>
        <span className="text-xs font-medium">Lv.{skill.level}</span>
        <div className="flex-1 h-1.5 bg-base-300 rounded-full overflow-hidden">
          <motion.div
            className="h-full bg-primary"
            style={{ width: widthPercent }}
          />
        </div>
      </div>
    );
  }

  return (
    <div className="bg-base-200 rounded-lg p-3">
      <div className="flex items-center justify-between mb-2">
        <div className="flex items-center gap-2">
          <span className="text-xl">{SKILL_ICONS[skill.category]}</span>
          <span className="font-medium">{skill.category}</span>
        </div>
        <div className="text-right">
          <span className="font-bold text-lg">Lv.{skill.level}</span>
          {skill.level < 5 && (
            <span className="text-xs opacity-70 ml-2">
              {Math.floor(skill.xp)} / {skill.xpToNextLevel + Math.floor(skill.xp - (skill.xp % (skill.xpToNextLevel / skill.levelProgress || 1)))} XP
            </span>
          )}
        </div>
      </div>

      {/* XP Progress bar */}
      {skill.level < 5 && (
        <div className="h-2 bg-base-300 rounded-full overflow-hidden">
          <motion.div
            className="h-full bg-gradient-to-r from-primary to-secondary"
            style={{ width: widthPercent }}
          />
        </div>
      )}

      {skill.level >= 5 && (
        <div className="text-center text-xs text-success font-medium">
          ‚òÖ MASTERED ‚òÖ
        </div>
      )}
    </div>
  );
});
```

Create src/components/LevelUpCelebration.tsx:

```typescript
import { useEffect } from 'react';
import { observer } from 'mobx-react-lite';
import { motion, AnimatePresence } from 'motion/react';
import { useGameStore } from '../stores/RootStore';
import type { SkillCategory } from '../types/game';

// Character celebration messages
const CELEBRATION_MESSAGES: Record<string, Record<SkillCategory, string[]>> = {
  elling: {
    Practical: ["I... I did it?", "Maybe I'm not so useless..."],
    Creative: ["The patterns are clearer now.", "I understand more."],
    Social: ["That wasn't so bad...", "People aren't all terrible."],
    Technical: ["Fascinating mechanism.", "I see how it works now."],
  },
  mother: {
    Practical: ["Practice makes perfect!", "Getting better every day."],
    Creative: ["How delightful!", "The mind stays sharp."],
    Social: ["Connection is important.", "We all need each other."],
    Technical: ["These old hands still work!", "Learning new tricks."],
  },
};

/**
 * Full-screen celebration overlay when character levels up
 */
export const LevelUpCelebration = observer(function LevelUpCelebration() {
  const { skillStore, characterStore } = useGameStore();
  const levelUp = skillStore.anyPendingLevelUp;

  // Auto-dismiss after 3 seconds
  useEffect(() => {
    if (levelUp) {
      const timer = setTimeout(() => {
        skillStore.clearLevelUp(levelUp.characterId, levelUp.skill);
      }, 3000);
      return () => clearTimeout(timer);
    }
  }, [levelUp, skillStore]);

  if (!levelUp) return null;

  const character = characterStore.getCharacter(levelUp.characterId);
  if (!character) return null;

  const messages = CELEBRATION_MESSAGES[levelUp.characterId]?.[levelUp.skill] ?? ["Level up!"];
  const message = messages[Math.floor(Math.random() * messages.length)];

  return (
    <AnimatePresence>
      <motion.div
        initial={{ opacity: 0 }}
        animate={{ opacity: 1 }}
        exit={{ opacity: 0 }}
        className="fixed inset-0 z-50 flex items-center justify-center bg-black/50"
        onClick={() => skillStore.clearLevelUp(levelUp.characterId, levelUp.skill)}
      >
        <motion.div
          initial={{ scale: 0.5, y: 50 }}
          animate={{ scale: 1, y: 0 }}
          exit={{ scale: 0.5, y: 50 }}
          className="bg-base-100 rounded-2xl p-8 shadow-2xl text-center max-w-sm"
        >
          {/* Character avatar placeholder */}
          <div className="text-6xl mb-4">
            {character.colors.primary.color === 'blue' ? 'üìò' : 'ü§ç'}
          </div>

          {/* Level up banner */}
          <motion.div
            initial={{ scale: 0 }}
            animate={{ scale: [0, 1.2, 1] }}
            transition={{ delay: 0.2, duration: 0.5 }}
            className="font-pixel text-2xl text-primary mb-2"
          >
            LEVEL UP!
          </motion.div>

          {/* Skill info */}
          <div className="text-lg font-bold mb-2">
            {character.name}'s {levelUp.skill}
          </div>
          <div className="text-3xl font-pixel text-secondary mb-4">
            Lv. {levelUp.newLevel}
          </div>

          {/* Character message */}
          <motion.div
            initial={{ opacity: 0, y: 10 }}
            animate={{ opacity: 1, y: 0 }}
            transition={{ delay: 0.5 }}
            className="italic text-base-content/80"
          >
            "{message}"
          </motion.div>

          {/* Tap to dismiss hint */}
          <div className="text-xs opacity-50 mt-4">
            Tap anywhere to continue
          </div>
        </motion.div>
      </motion.div>
    </AnimatePresence>
  );
});
```
  </action>
  <verify>
`npx tsc --noEmit` passes. Both components render without errors.
  </verify>
  <done>
SkillProgress shows skill level and animated XP bar.
LevelUpCelebration displays modal with character message on level-up.
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate skills into CharacterPanel and add LevelUpCelebration to Game</name>
  <files>src/components/CharacterPanel.tsx, src/components/Game.tsx</files>
  <action>
Update src/components/CharacterPanel.tsx:

1. Import SkillProgress and useGameStore:
```typescript
import { SkillProgress } from './SkillProgress';
import { useGameStore } from '../stores/RootStore';
```

2. Add skills section to the panel (after the existing needs/overskudd display):
```typescript
// Inside the observer component, get skillStore
const { skillStore } = useGameStore();

// In the character display section, add skills:
{/* Skills Section */}
<div className="mt-4">
  <h4 className="text-sm font-medium text-base-content/70 mb-2">Skills</h4>
  <div className="grid grid-cols-2 gap-2">
    {(['Practical', 'Creative', 'Social', 'Technical'] as const).map(category => {
      const skill = skillStore.getSkill(selectedCharacter.id, category);
      return skill ? (
        <SkillProgress key={category} skill={skill} compact />
      ) : null;
    })}
  </div>
</div>
```

Update src/components/Game.tsx:

1. Import LevelUpCelebration:
```typescript
import { LevelUpCelebration } from './LevelUpCelebration';
```

2. Add LevelUpCelebration at the end of the component (after ActivityModal):
```tsx
{/* Level up celebration overlay */}
<LevelUpCelebration />
```
  </action>
  <verify>
1. `npm run dev` starts without errors
2. Click character - panel shows skills with progress bars
3. Let character complete activities repeatedly until level-up
4. Level-up celebration modal appears with character message
5. Click/tap to dismiss celebration
  </verify>
  <done>
CharacterPanel shows all 4 skill categories with progress.
LevelUpCelebration triggers on level-up with in-character message.
Game integrates celebration overlay.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete Phase 3 Activity Loop system:
1. Skills and resources with progression
2. Floating number feedback on activity completion
3. Resource bar tracking global resources
4. Player intervention modal with activity assignment
5. Refusal messages with personality flavor
6. Skill progress display and level-up celebration
  </what-built>
  <how-to-verify>
1. Open the game at http://localhost:5173
2. Watch characters complete activities autonomously
3. Verify floating numbers pop up (+15 creativity, etc.)
4. Verify resource bar at top updates and pulses
5. Click a character to open activity modal
6. Check that success chance and attitude faces show correctly
7. Force an activity on Elling (especially if he's reluctant)
8. Verify refusal message appears with Blue personality flavor
9. Drain Elling's needs (debug button) and try to force activity
10. Verify "Too tired" style message appears
11. Let characters complete many activities until a level-up
12. Verify level-up celebration modal appears with character quote
13. Click to dismiss celebration
14. Check CharacterPanel shows updated skill levels

Overall impression check:
- Does activity completion feel satisfying?
- Are the floating numbers readable and juicy?
- Do skill level-ups feel rewarding?
- Does the intervention system feel meaningful?
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no type errors
2. All visual feedback elements work together:
   - Floating numbers on completion
   - Resource bar updates with pulse
   - Skill XP progress in CharacterPanel
   - Level-up celebration on skill advancement
3. Player intervention flow is complete:
   - Modal opens on character click
   - Activities show full info
   - Force works with refusal messaging
4. Human verification confirms satisfying "juice"
</verification>

<success_criteria>
- Skill progress visible in CharacterPanel
- XP bar animates smoothly with spring physics
- Level-up celebration triggers with in-character message
- Combined feedback creates satisfying loop
- Human verifies overall feel is "juicy" and satisfying
</success_criteria>

<output>
After completion, create `.planning/phases/03-activity-loop/03-05-SUMMARY.md`
</output>
