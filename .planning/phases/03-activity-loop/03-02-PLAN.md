---
phase: 03-activity-loop
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/stores/CharacterStore.ts
  - src/systems/SkillSystem.ts
autonomous: true

must_haves:
  truths:
    - "Completing an activity grants XP to the relevant skill"
    - "Activity output is modified by skill level (higher skill = more output)"
    - "Low-skill attempts can fail based on success chance calculation"
    - "Failed activities produce reduced output (50%)"
    - "Critical success occurs occasionally at higher skill levels"
  artifacts:
    - path: "src/systems/SkillSystem.ts"
      provides: "Success chance calculation, output modifier, XP grant amount"
      exports: ["calculateSuccessChance", "calculateOutput", "calculateXPGain"]
      min_lines: 40
    - path: "src/stores/CharacterStore.ts"
      provides: "Extended completeActivity with skill/resource integration"
      contains: "skillStore|resourceStore"
  key_links:
    - from: "src/stores/CharacterStore.ts"
      to: "src/systems/SkillSystem.ts"
      via: "import and usage"
      pattern: "calculateSuccessChance|calculateOutput"
    - from: "src/stores/CharacterStore.ts"
      to: "src/stores/SkillStore.ts"
      via: "rootStore.skillStore"
      pattern: "skillStore\\.grantXP"
---

<objective>
Integrate skills and resources into activity completion with success/failure mechanics.

Purpose: This connects the skill progression system to actual gameplay. When characters complete activities, they gain XP and produce resources modified by their skill level. Low-skill attempts can fail.

Output: SkillSystem with calculation functions, Character.completeActivity updated to use skills/resources.
</objective>

<execution_context>
@/Users/godstemning/.claude/get-shit-done/workflows/execute-plan.md
@/Users/godstemning/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-activity-loop/03-CONTEXT.md
@.planning/phases/03-activity-loop/03-RESEARCH.md
@.planning/phases/03-activity-loop/03-01-SUMMARY.md

@src/stores/CharacterStore.ts
@src/stores/RootStore.ts
@src/data/skills.ts
@src/types/game.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SkillSystem with calculation functions</name>
  <files>src/systems/SkillSystem.ts</files>
  <action>
Create src/systems/SkillSystem.ts with pure calculation functions:

1. calculateSuccessChance(skillLevel: number, difficulty: number): number
   - Formula: 50 + (skillLevel * 10) - ((difficulty - 1) * 15)
   - Clamp result between 10 and 95
   - Example: Level 1 vs Difficulty 1 = 60%
   - Example: Level 3 vs Difficulty 2 = 65%
   - Example: Level 1 vs Difficulty 3 = 30%

2. calculateOutput(baseAmount: number, skillLevel: number, succeeded: boolean, critical: boolean): number
   - Import getOutputModifier from skills.ts
   - If failed: return Math.floor(baseAmount * 0.5) (50% on failure)
   - If critical: return Math.floor(baseAmount * getOutputModifier(skillLevel) * 1.5) (+50% bonus)
   - Otherwise: return Math.floor(baseAmount * getOutputModifier(skillLevel))

3. calculateXPGain(difficulty: number, succeeded: boolean): number
   - Base XP: 10 * difficulty
   - If failed: return Math.floor(base * 0.5) (still learn from failure)
   - If succeeded: return base

4. rollForSuccess(successChance: number): boolean
   - return Math.random() * 100 < successChance

5. rollForCritical(skillLevel: number): boolean
   - Critical chance: 5 + (skillLevel * 5)%
   - return Math.random() * 100 < criticalChance
   - Only called on successful activities

6. Type for activity result:
```typescript
export interface ActivityResult {
  succeeded: boolean;
  critical: boolean;
  outputs: Array<{ resource: ResourceType; amount: number }>;
  xpGained: number;
  skillCategory?: SkillCategory;
}
```

7. processActivityCompletion function:
```typescript
export function processActivityCompletion(
  activity: Activity,
  skillLevel: number
): ActivityResult {
  const difficulty = activity.difficulty ?? 1;
  const successChance = calculateSuccessChance(skillLevel, difficulty);
  const succeeded = rollForSuccess(successChance);
  const critical = succeeded && rollForCritical(skillLevel);

  const outputs = (activity.outputs ?? []).map(output => ({
    resource: output.resource,
    amount: calculateOutput(output.baseAmount, skillLevel, succeeded, critical),
  }));

  const xpGained = activity.skillCategory
    ? calculateXPGain(difficulty, succeeded)
    : 0;

  return {
    succeeded,
    critical,
    outputs,
    xpGained,
    skillCategory: activity.skillCategory,
  };
}
```
  </action>
  <verify>
Import functions and test:
- calculateSuccessChance(1, 1) === 60
- calculateSuccessChance(3, 2) === 65
- calculateOutput(10, 3, true, false) === 15 (10 * 1.5 modifier)
- calculateOutput(10, 1, false, false) === 5 (50% on failure)
  </verify>
  <done>
SkillSystem exports all calculation functions and processActivityCompletion.
Functions are pure and testable.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate skills and resources into Character.completeActivity</name>
  <files>src/stores/CharacterStore.ts</files>
  <action>
Modify Character.completeActivity() in CharacterStore.ts:

1. Import processActivityCompletion from SkillSystem
2. Import SkillCategory from game.ts

3. Add new observable property to Character:
```typescript
lastActivityResult: ActivityResult | null = null;
```

4. Update completeActivity():
```typescript
completeActivity(): void {
  if (!this.currentActivity) return;

  const activity = this.currentActivity;

  // Get skill level if activity has a skill category
  let skillLevel = 1;
  if (activity.skillCategory) {
    const skill = this.characterStore.rootStore.skillStore.getSkill(
      this.id,
      activity.skillCategory
    );
    skillLevel = skill?.level ?? 1;
  }

  // Process activity with skill system
  const result = processActivityCompletion(activity, skillLevel);
  this.lastActivityResult = result;

  // Grant XP if skill was involved
  if (result.skillCategory && result.xpGained > 0) {
    this.characterStore.rootStore.skillStore.grantXP(
      this.id,
      result.skillCategory,
      result.xpGained
    );
  }

  // Add resources to global pool
  for (const output of result.outputs) {
    this.characterStore.rootStore.resourceStore.addResource(
      output.resource,
      output.amount
    );
  }

  // Apply effects to needs (existing code)
  const effects = activity.effects;
  if (effects.energy) {
    this.needs.energy = Math.max(0, Math.min(100, this.needs.energy + effects.energy));
  }
  if (effects.social) {
    this.needs.social = Math.max(0, Math.min(100, this.needs.social + effects.social));
  }
  if (effects.purpose) {
    this.needs.purpose = Math.max(0, Math.min(100, this.needs.purpose + effects.purpose));
  }

  // Reset state
  this.currentActivity = null;
  this.activityProgress = 0;
  this.state = 'idle';
  this.idleCooldown = 2;
}
```

5. Make lastActivityResult observable:
```typescript
makeAutoObservable(this, {
  // ... existing exclusions
  lastActivityResult: true, // explicitly observable for UI reactivity
});
```

6. Add a clearLastActivityResult method for UI to call after displaying:
```typescript
clearLastActivityResult(): void {
  this.lastActivityResult = null;
}
```
  </action>
  <verify>
1. `npx tsc --noEmit` passes
2. In game, let a character complete an activity
3. Check console:
   - `rootStore.resourceStore.getResource('creativity')` should be > 0 after reading
   - `rootStore.skillStore.getSkill('elling', 'Creative')?.xp` should be > 0 after reading
  </verify>
  <done>
Character.completeActivity integrates with SkillSystem, grants XP, produces resources.
lastActivityResult available for UI to display feedback.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no type errors
2. `npm run dev` starts without errors
3. Let Elling complete a reading activity:
   - Creativity resource increases
   - Elling's Creative skill XP increases
   - Console shows lastActivityResult with succeeded/critical/outputs
4. Force a low-skill character to attempt difficult activity:
   - Some attempts fail (succeeded: false)
   - Failed attempts produce 50% output
</verification>

<success_criteria>
- SkillSystem functions are pure and calculate correctly
- Completing activities grants XP to the appropriate skill
- Resources are added to ResourceStore on completion
- Success/failure affects output amount
- lastActivityResult is available for UI feedback
</success_criteria>

<output>
After completion, create `.planning/phases/03-activity-loop/03-02-SUMMARY.md`
</output>
