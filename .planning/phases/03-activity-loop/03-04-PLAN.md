---
phase: 03-activity-loop
plan: 04
type: execute
wave: 3
depends_on: ["03-02"]
files_modified:
  - src/components/ActivityModal.tsx
  - src/components/RefusalMessage.tsx
  - src/stores/CharacterStore.ts
  - src/stores/InteractionStore.ts
  - src/components/Game.tsx
autonomous: true

must_haves:
  truths:
    - "Player can click character to open activity assignment modal"
    - "Modal shows all activities with success chance and character attitude"
    - "Player can force an activity on a character (intervention)"
    - "Characters show personality-flavored refusal messages when reluctant"
    - "Forcing activities past refusal has consequences based on context"
  artifacts:
    - path: "src/components/ActivityModal.tsx"
      provides: "Full-screen modal for activity selection"
      min_lines: 80
    - path: "src/components/RefusalMessage.tsx"
      provides: "Personality-flavored refusal display"
      min_lines: 20
    - path: "src/stores/InteractionStore.ts"
      provides: "Modal state management and force assignment"
      contains: "activityModalOpen|forceActivity"
  key_links:
    - from: "src/components/ActivityModal.tsx"
      to: "src/stores/InteractionStore.ts"
      via: "modal state and actions"
      pattern: "activityModalOpen|closeActivityModal"
    - from: "src/components/Game.tsx"
      to: "src/components/ActivityModal.tsx"
      via: "component rendering"
      pattern: "<ActivityModal"
---

<objective>
Implement player intervention with activity assignment modal and refusal messaging.

Purpose: Players need to be able to direct characters to specific activities. This is how players "push" characters toward growth vs letting them default to comfort. Refusal messages add personality flavor.

Output: ActivityModal component, RefusalMessage component, InteractionStore extensions for modal state.
</objective>

<execution_context>
@/Users/godstemning/.claude/get-shit-done/workflows/execute-plan.md
@/Users/godstemning/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-activity-loop/03-CONTEXT.md
@.planning/phases/03-activity-loop/03-RESEARCH.md
@.planning/phases/03-activity-loop/03-02-SUMMARY.md

@src/stores/InteractionStore.ts
@src/stores/CharacterStore.ts
@src/components/Game.tsx
@src/systems/SkillSystem.ts
@src/data/activities.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend InteractionStore for activity modal state</name>
  <files>src/stores/InteractionStore.ts</files>
  <action>
Update src/stores/InteractionStore.ts to add modal state management:

1. Add observable properties:
```typescript
activityModalOpen: boolean = false;
assigningCharacterId: string | null = null;
```

2. Add actions:
```typescript
/**
 * Open activity modal for a character
 */
openActivityModal(characterId: string): void {
  this.assigningCharacterId = characterId;
  this.activityModalOpen = true;
}

/**
 * Close activity modal
 */
closeActivityModal(): void {
  this.activityModalOpen = false;
  this.assigningCharacterId = null;
}

/**
 * Force assign an activity to the currently selected character
 * Returns true if successful, false if character is in a state that can't be interrupted
 */
forceAssignActivity(activityId: string): boolean {
  if (!this.assigningCharacterId) return false;

  const character = this.rootStore.characterStore.getCharacter(this.assigningCharacterId);
  if (!character) return false;

  // Can't interrupt if character is walking or performing
  if (character.state === 'walking' || character.state === 'performing') {
    return false;
  }

  // Find activity
  const activity = ACTIVITIES.find(a => a.id === activityId);
  if (!activity) return false;

  // Force the activity
  character.forceActivity(activity);

  this.closeActivityModal();
  return true;
}
```

3. Import ACTIVITIES from '../data/activities'
  </action>
  <verify>
`npx tsc --noEmit` passes. Modal state properties exist on InteractionStore.
  </verify>
  <done>
InteractionStore has activityModalOpen, assigningCharacterId, and forceAssignActivity action.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add force activity and refusal to Character class</name>
  <files>src/stores/CharacterStore.ts</files>
  <action>
Update Character class in CharacterStore.ts:

1. Add refusal message observable:
```typescript
refusalMessage: string | null = null;
refusalIcon: string | null = null;
```

2. Add method to get character attitude toward an activity:
```typescript
/**
 * Get character's attitude toward an activity
 * Returns: 'eager' | 'neutral' | 'reluctant' | 'refusing'
 */
getAttitudeToward(activity: Activity): 'eager' | 'neutral' | 'reluctant' | 'refusing' {
  // Can't do anything if performing
  if (this.state === 'walking' || this.state === 'performing') {
    return 'refusing';
  }

  // Low overskudd = reluctant or refusing
  if (this.overskudd < 20) return 'refusing';
  if (this.overskudd < 40) return 'reluctant';

  // Check color affinity
  const colorMatch = this.calculateColorMatch(activity);
  if (colorMatch > 0.6) return 'eager';
  if (colorMatch < 0.3) return 'reluctant';
  return 'neutral';
}

/**
 * Helper to calculate color match (reuse Utility AI logic)
 */
private calculateColorMatch(activity: Activity): number {
  const affinities = activity.colorAffinities;
  if (Object.keys(affinities).length === 0) return 0.5; // Neutral

  let totalMatch = 0;
  let totalWeight = 0;

  // Check primary color
  const primaryAffinity = affinities[this.colors.primary.color] ?? 0;
  totalMatch += primaryAffinity * this.colors.primary.intensity;
  totalWeight += this.colors.primary.intensity;

  // Check secondary if exists
  if (this.colors.secondary) {
    const secondaryAffinity = affinities[this.colors.secondary.color] ?? 0;
    totalMatch += secondaryAffinity * this.colors.secondary.intensity;
    totalWeight += this.colors.secondary.intensity;
  }

  return totalWeight > 0 ? totalMatch / totalWeight : 0.5;
}
```

3. Add forceActivity method:
```typescript
/**
 * Force character to do an activity (player intervention)
 * May cause refusal message based on context
 */
forceActivity(activity: Activity): void {
  const attitude = this.getAttitudeToward(activity);

  // Generate refusal message based on personality and reason
  if (attitude === 'refusing' || attitude === 'reluctant') {
    this.generateRefusalMessage(activity, attitude);
  } else {
    this.refusalMessage = null;
    this.refusalIcon = null;
  }

  // Still do the activity even if reluctant (that's what forcing means)
  // Only truly refuse if already busy
  if (this.state === 'walking' || this.state === 'performing') {
    return;
  }

  // Set activity and start walking
  this.currentActivity = activity;
  this.state = 'walking';
  this.pendingScores = [];

  // Clear decision state
  this.decisionStartTime = 0;
}

/**
 * Generate personality-flavored refusal/reluctance message
 */
private generateRefusalMessage(activity: Activity, attitude: 'refusing' | 'reluctant'): void {
  const isBlue = this.colors.primary.color === 'blue';
  const isWhite = this.colors.primary.color === 'white';

  if (this.overskudd < 20) {
    // Exhaustion refusal
    this.refusalIcon = 'üò´';
    this.refusalMessage = isBlue
      ? "I can't... I just can't right now."
      : "I'm too tired for this.";
  } else if (this.overskudd < 40) {
    // Low energy reluctance
    this.refusalIcon = 'üòì';
    this.refusalMessage = isBlue
      ? "Must I? I'm not sure I have it in me..."
      : "I suppose I can try...";
  } else if (this.calculateColorMatch(activity) < 0.3) {
    // Personality mismatch
    this.refusalIcon = 'üòï';
    this.refusalMessage = isBlue
      ? "That's not really my thing..."
      : isWhite
        ? "If you think it's important..."
        : "I'd rather not.";
  }

  // Auto-clear after 3 seconds
  setTimeout(() => {
    runInAction(() => {
      this.refusalMessage = null;
      this.refusalIcon = null;
    });
  }, 3000);
}

/**
 * Clear refusal message manually
 */
clearRefusal(): void {
  this.refusalMessage = null;
  this.refusalIcon = null;
}
```

4. Make refusalMessage and refusalIcon observable in makeAutoObservable.
  </action>
  <verify>
`npx tsc --noEmit` passes. Character has forceActivity method and refusal properties.
  </verify>
  <done>
Character can be forced to activities.
Refusal messages generated based on personality and overskudd.
Attitude calculation determines eager/neutral/reluctant/refusing.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create ActivityModal and RefusalMessage components</name>
  <files>src/components/ActivityModal.tsx, src/components/RefusalMessage.tsx, src/components/Game.tsx</files>
  <action>
Create src/components/RefusalMessage.tsx:

```typescript
import { observer } from 'mobx-react-lite';
import { motion, AnimatePresence } from 'motion/react';
import type { Character } from '../stores/CharacterStore';

interface RefusalMessageProps {
  character: Character;
}

/**
 * Displays personality-flavored refusal message above character
 */
export const RefusalMessage = observer(function RefusalMessage({ character }: RefusalMessageProps) {
  if (!character.refusalMessage) return null;

  return (
    <AnimatePresence>
      <motion.div
        initial={{ opacity: 0, y: 10 }}
        animate={{ opacity: 1, y: 0 }}
        exit={{ opacity: 0, y: -10 }}
        className="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 whitespace-nowrap"
      >
        <div className="bg-base-100 rounded-lg px-3 py-2 shadow-lg border border-base-300">
          <span className="mr-2">{character.refusalIcon}</span>
          <span className="text-sm italic">{character.refusalMessage}</span>
        </div>
      </motion.div>
    </AnimatePresence>
  );
});
```

Create src/components/ActivityModal.tsx:

```typescript
import { useRef, useEffect } from 'react';
import { observer } from 'mobx-react-lite';
import { useGameStore } from '../stores/RootStore';
import { ACTIVITIES, getRegularActivities } from '../data/activities';
import { calculateSuccessChance } from '../systems/SkillSystem';
import type { Activity } from '../types/game';

// Attitude face icons
const ATTITUDE_ICONS = {
  eager: 'üòä',
  neutral: 'üòê',
  reluctant: 'üòü',
  refusing: 'üò£',
} as const;

/**
 * Full-screen modal for assigning activities to characters
 */
export const ActivityModal = observer(function ActivityModal() {
  const dialogRef = useRef<HTMLDialogElement>(null);
  const { interactionStore, characterStore, skillStore } = useGameStore();

  const isOpen = interactionStore.activityModalOpen;
  const characterId = interactionStore.assigningCharacterId;
  const character = characterId ? characterStore.getCharacter(characterId) : null;

  // Open/close modal based on state
  useEffect(() => {
    if (isOpen && dialogRef.current) {
      dialogRef.current.showModal();
    } else if (!isOpen && dialogRef.current?.open) {
      dialogRef.current.close();
    }
  }, [isOpen]);

  // Handle dialog close (ESC key or backdrop click)
  const handleClose = () => {
    interactionStore.closeActivityModal();
  };

  // Handle activity selection
  const handleSelectActivity = (activity: Activity) => {
    interactionStore.forceAssignActivity(activity.id);
  };

  if (!character) return null;

  const activities = getRegularActivities();

  return (
    <dialog
      ref={dialogRef}
      className="modal"
      onClose={handleClose}
    >
      <div className="modal-box max-w-2xl">
        <h3 className="text-lg font-bold mb-4">
          Assign Activity to {character.name}
        </h3>

        {/* Character status summary */}
        <div className="mb-4 p-3 bg-base-200 rounded-lg">
          <div className="flex gap-4 text-sm">
            <span>Overskudd: <strong>{Math.round(character.overskudd)}</strong></span>
            <span>State: <strong>{character.state}</strong></span>
          </div>
        </div>

        {/* Activity list */}
        <div className="grid gap-2 max-h-96 overflow-y-auto">
          {activities.map(activity => {
            const attitude = character.getAttitudeToward(activity);
            const skillLevel = activity.skillCategory
              ? (skillStore.getSkill(character.id, activity.skillCategory)?.level ?? 1)
              : 1;
            const successChance = calculateSuccessChance(
              skillLevel,
              activity.difficulty ?? 1
            );

            const isDisabled = attitude === 'refusing' && (
              character.state === 'walking' || character.state === 'performing'
            );

            return (
              <button
                key={activity.id}
                className={`btn btn-outline justify-start h-auto py-3 ${
                  attitude === 'eager' ? 'btn-success' :
                  attitude === 'reluctant' ? 'btn-warning' :
                  attitude === 'refusing' ? 'btn-error' : ''
                }`}
                onClick={() => handleSelectActivity(activity)}
                disabled={isDisabled}
              >
                <div className="flex items-center w-full gap-3">
                  {/* Activity icon */}
                  <span className="text-2xl">{activity.icon}</span>

                  {/* Activity info */}
                  <div className="flex-1 text-left">
                    <div className="font-medium">{activity.name}</div>
                    <div className="text-xs opacity-70">
                      {activity.skillCategory && (
                        <span className="mr-2">
                          {activity.skillCategory} (Lv.{skillLevel})
                        </span>
                      )}
                      {activity.outputs?.map(o => (
                        <span key={o.resource} className="mr-2">
                          +{o.baseAmount} {o.resource}
                        </span>
                      ))}
                    </div>
                  </div>

                  {/* Success chance */}
                  <div className="text-right">
                    <div className="text-sm font-medium">{successChance}%</div>
                    <div className="text-xs opacity-70">success</div>
                  </div>

                  {/* Attitude face */}
                  <div className="text-2xl" title={attitude}>
                    {ATTITUDE_ICONS[attitude]}
                  </div>
                </div>
              </button>
            );
          })}
        </div>

        {/* Warning if character is reluctant/refusing */}
        {character.overskudd < 40 && (
          <div className="alert alert-warning mt-4">
            <span>
              {character.name} is low on energy. Forcing activities may cause frustration.
            </span>
          </div>
        )}

        {/* Modal actions */}
        <div className="modal-action">
          <form method="dialog">
            <button className="btn" onClick={handleClose}>Cancel</button>
          </form>
        </div>
      </div>

      {/* Backdrop */}
      <form method="dialog" className="modal-backdrop">
        <button onClick={handleClose}>close</button>
      </form>
    </dialog>
  );
});
```

Update src/components/Game.tsx:

1. Import ActivityModal and RefusalMessage:
```typescript
import { ActivityModal } from './ActivityModal';
import { RefusalMessage } from './RefusalMessage';
```

2. Update CharacterSprite click handler to open modal:
```typescript
<CharacterSprite
  key={character.id}
  character={character}
  isSelected={interactionStore.selectedCharacterId === character.id}
  onClick={() => interactionStore.openActivityModal(character.id)}
/>
```

3. Add ActivityModal at the end of the component (before closing div):
```tsx
{/* Activity assignment modal */}
<ActivityModal />
```

4. In CharacterSprite rendering, add RefusalMessage (update CharacterSprite.tsx if needed):
   - If RefusalMessage is rendered in CharacterSprite, add it there
   - Otherwise render it alongside characters in Game.tsx
  </action>
  <verify>
1. `npm run dev` starts without errors
2. Click on a character - activity modal opens
3. Modal shows all activities with success chance and attitude face
4. Select an activity - character starts walking to it
5. Force activity on low-overskudd character - refusal message appears
  </verify>
  <done>
ActivityModal displays activities with success chance and attitude indicators.
Player can force activities on characters.
RefusalMessage shows personality-flavored responses.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no type errors
2. `npm run dev` starts without errors
3. Click character -> modal opens with activity list
4. Each activity shows:
   - Icon and name
   - Skill category and level
   - Resource output
   - Success chance percentage
   - Character attitude face (eager/neutral/reluctant/refusing)
5. Select activity -> character walks to it
6. Drain character needs, open modal -> shows warning about low energy
7. Force reluctant activity -> refusal message appears above character
8. Refusal message disappears after 3 seconds
</verification>

<success_criteria>
- Activity modal opens on character click
- All activities visible with full info (skill, output, chance, attitude)
- Player can force any activity (except when character is busy)
- Refusal messages are personality-flavored (Blue vs White different)
- Warning shown when forcing activities on low-energy character
</success_criteria>

<output>
After completion, create `.planning/phases/03-activity-loop/03-04-SUMMARY.md`
</output>
